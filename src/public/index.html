<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tailboard</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="icon" id="faviconLink" href="/api/favicon">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" id="metaThemeColor" content="#57534e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Tailboard">
  <style>
    /* Drag handle cursor â€” also declared here so non-Tailwind browsers cover it */
    .drag-handle { cursor: grab; }
    .drag-handle:active { cursor: grabbing; }
    /* Sharp corners mode */
    .sharp, .sharp * { border-radius: 0 !important; }
    /* Link row focus ring for keyboard nav */
    .link-row:focus { outline: 2px solid #6366f1; outline-offset: -2px; }
  </style>
</head>
<body class="bg-white dark:bg-stone-950">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PALETTE LOOKUP TABLES
     All class strings are literals here so the Tailwind CLI scanner picks
     them up at build time â€” never build class names via string concatenation.
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// TOPBAR[palette] â€” solid coloured top bar; page/cards are always stone (see FIXED)
const TOPBAR = {
  stone:   { bar:'bg-stone-600 dark:bg-stone-800 border-stone-700 dark:border-stone-900',         text:'text-white'                 },
  gray:    { bar:'bg-gray-600 dark:bg-gray-800 border-gray-700 dark:border-gray-900',             text:'text-white'                 },
  zinc:    { bar:'bg-zinc-600 dark:bg-zinc-800 border-zinc-700 dark:border-zinc-900',             text:'text-white'                 },
  slate:   { bar:'bg-slate-600 dark:bg-slate-800 border-slate-700 dark:border-slate-900',         text:'text-white'                 },
  neutral: { bar:'bg-neutral-600 dark:bg-neutral-800 border-neutral-700 dark:border-neutral-900', text:'text-white'                 },
  red:     { bar:'bg-red-600 dark:bg-red-800 border-red-700 dark:border-red-900',                 text:'text-white'                 },
  orange:  { bar:'bg-orange-500 dark:bg-orange-700 border-orange-600 dark:border-orange-800',     text:'text-white'                 },
  amber:   { bar:'bg-amber-400 dark:bg-amber-700 border-amber-500 dark:border-amber-800',         text:'text-black dark:text-white' },
  yellow:  { bar:'bg-yellow-400 dark:bg-yellow-600 border-yellow-500 dark:border-yellow-700',     text:'text-black dark:text-white' },
  lime:    { bar:'bg-lime-500 dark:bg-lime-700 border-lime-600 dark:border-lime-800',             text:'text-white'                 },
  green:   { bar:'bg-green-600 dark:bg-green-800 border-green-700 dark:border-green-900',         text:'text-white'                 },
  emerald: { bar:'bg-emerald-600 dark:bg-emerald-800 border-emerald-700 dark:border-emerald-900', text:'text-white'                 },
  teal:    { bar:'bg-teal-600 dark:bg-teal-800 border-teal-700 dark:border-teal-900',             text:'text-white'                 },
  cyan:    { bar:'bg-cyan-500 dark:bg-cyan-700 border-cyan-600 dark:border-cyan-800',             text:'text-white'                 },
  sky:     { bar:'bg-sky-500 dark:bg-sky-700 border-sky-600 dark:border-sky-800',                 text:'text-white'                 },
  blue:    { bar:'bg-blue-600 dark:bg-blue-800 border-blue-700 dark:border-blue-900',             text:'text-white'                 },
  indigo:  { bar:'bg-indigo-600 dark:bg-indigo-800 border-indigo-700 dark:border-indigo-900',     text:'text-white'                 },
  violet:  { bar:'bg-violet-600 dark:bg-violet-800 border-violet-700 dark:border-violet-900',     text:'text-white'                 },
  purple:  { bar:'bg-purple-600 dark:bg-purple-800 border-purple-700 dark:border-purple-900',     text:'text-white'                 },
  fuchsia: { bar:'bg-fuchsia-600 dark:bg-fuchsia-800 border-fuchsia-700 dark:border-fuchsia-900', text:'text-white'                 },
  pink:    { bar:'bg-pink-500 dark:bg-pink-700 border-pink-600 dark:border-pink-800',             text:'text-white'                 },
  rose:    { bar:'bg-rose-600 dark:bg-rose-800 border-rose-700 dark:border-rose-900',             text:'text-white'                 },
};

// FIXED â€” page, cards and body text are always stone regardless of palette
const FIXED = {
  page: 'bg-white dark:bg-stone-950',
  card: 'bg-white dark:bg-stone-800 border-stone-200 dark:border-stone-700',
  text: 'text-stone-900 dark:text-stone-50',
  sub:  'text-stone-500 dark:text-stone-400',
};

// ACCENT[color] â€” group header bar + left border stripe on link cards
const ACCENT = {
  stone:   { header:'bg-stone-600 text-white',   swatch:'bg-stone-500',   border:'border-l-4 border-stone-500'   },
  gray:    { header:'bg-gray-600 text-white',     swatch:'bg-gray-500',     border:'border-l-4 border-gray-500'     },
  zinc:    { header:'bg-zinc-600 text-white',     swatch:'bg-zinc-500',     border:'border-l-4 border-zinc-500'     },
  slate:   { header:'bg-slate-600 text-white',    swatch:'bg-slate-500',    border:'border-l-4 border-slate-500'    },
  neutral: { header:'bg-neutral-600 text-white',  swatch:'bg-neutral-500',  border:'border-l-4 border-neutral-500'  },
  red:     { header:'bg-red-600 text-white',      swatch:'bg-red-500',      border:'border-l-4 border-red-500'      },
  orange:  { header:'bg-orange-500 text-white',   swatch:'bg-orange-500',   border:'border-l-4 border-orange-500'   },
  amber:   { header:'bg-amber-500 text-white',    swatch:'bg-amber-500',    border:'border-l-4 border-amber-500'    },
  yellow:  { header:'bg-yellow-400 text-black',   swatch:'bg-yellow-400',   border:'border-l-4 border-yellow-400'   },
  lime:    { header:'bg-lime-500 text-white',     swatch:'bg-lime-500',     border:'border-l-4 border-lime-500'     },
  green:   { header:'bg-green-600 text-white',    swatch:'bg-green-500',    border:'border-l-4 border-green-500'    },
  emerald: { header:'bg-emerald-600 text-white',  swatch:'bg-emerald-500',  border:'border-l-4 border-emerald-500'  },
  teal:    { header:'bg-teal-600 text-white',     swatch:'bg-teal-500',     border:'border-l-4 border-teal-500'     },
  cyan:    { header:'bg-cyan-500 text-white',     swatch:'bg-cyan-500',     border:'border-l-4 border-cyan-500'     },
  sky:     { header:'bg-sky-500 text-white',      swatch:'bg-sky-500',      border:'border-l-4 border-sky-500'      },
  blue:    { header:'bg-blue-600 text-white',     swatch:'bg-blue-500',     border:'border-l-4 border-blue-500'     },
  indigo:  { header:'bg-indigo-600 text-white',   swatch:'bg-indigo-500',   border:'border-l-4 border-indigo-500'   },
  violet:  { header:'bg-violet-600 text-white',   swatch:'bg-violet-500',   border:'border-l-4 border-violet-500'   },
  purple:  { header:'bg-purple-600 text-white',   swatch:'bg-purple-500',   border:'border-l-4 border-purple-500'   },
  fuchsia: { header:'bg-fuchsia-600 text-white',  swatch:'bg-fuchsia-500',  border:'border-l-4 border-fuchsia-500'  },
  pink:    { header:'bg-pink-500 text-white',     swatch:'bg-pink-500',     border:'border-l-4 border-pink-500'     },
  rose:    { header:'bg-rose-600 text-white',     swatch:'bg-rose-500',     border:'border-l-4 border-rose-500'     },
};

const PALETTES = Object.keys(TOPBAR);

// PALETTE_HEX â€” hex values for theme-color meta and manifest (mirrors server)
const PALETTE_HEX = { stone:'#57534e', gray:'#4b5563', zinc:'#52525b', slate:'#475569',
  neutral:'#525252', red:'#dc2626', orange:'#f97316', amber:'#d97706', yellow:'#ca8a04',
  lime:'#65a30d', green:'#16a34a', emerald:'#059669', teal:'#0d9488', cyan:'#0891b2',
  sky:'#0284c7', blue:'#2563eb', indigo:'#4f46e5', violet:'#7c3aed', purple:'#9333ea',
  fuchsia:'#a21caf', pink:'#db2777', rose:'#e11d48' };

// ICON_BG â€” squircle background options for link icons
const ICON_BG_OPTIONS = [
  { key: 'none',    label: 'None',    hex: null        },
  { key: 'white',   label: 'White',   hex: '#ffffff'   },
  { key: 'light',   label: 'Light',   hex: '#f1f5f9'   },
  { key: 'dark',    label: 'Dark',    hex: '#18181b'   },
  { key: 'blue',    label: 'Blue',    hex: '#3b82f6'   },
  { key: 'indigo',  label: 'Indigo',  hex: '#6366f1'   },
  { key: 'violet',  label: 'Violet',  hex: '#7c3aed'   },
  { key: 'green',   label: 'Green',   hex: '#22c55e'   },
  { key: 'teal',    label: 'Teal',    hex: '#14b8a6'   },
  { key: 'orange',  label: 'Orange',  hex: '#f97316'   },
  { key: 'red',     label: 'Red',     hex: '#ef4444'   },
  { key: 'pink',    label: 'Pink',    hex: '#ec4899'   },
  { key: 'yellow',  label: 'Yellow',  hex: '#eab308'   },
];
const ICON_BG_MAP = Object.fromEntries(
  ICON_BG_OPTIONS.filter(o => o.hex).map(o => [o.key, o.hex])
);

// WIDGET â€” literal class strings used by the clock/weather card (Tailwind scanner)
const WIDGET = {
  time: 'text-4xl font-bold tabular-nums leading-none',
  date: 'text-sm mt-1',
  preWrap: 'whitespace-pre-wrap break-words',
};
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HTML SHELL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Top bar -->
<header id="topbar" class="sticky top-0 z-30 flex items-center justify-between px-6 py-3 shadow-sm border-b border-transparent transition-colors">
  <div class="flex items-center gap-3">
    <h1 id="dashTitle" class="text-xl font-semibold tracking-tight cursor-pointer select-none" title="Click to rename"></h1>
  </div>
  <div class="relative">
    <button id="menuBtn" title="Menu"
      class="rounded-lg p-2 opacity-70 hover:opacity-100 transition-opacity">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    <div id="menuDropdown"
      class="hidden absolute right-0 top-full mt-1 w-52 rounded-xl shadow-xl overflow-hidden border bg-white dark:bg-stone-800 border-stone-200 dark:border-stone-700 py-1 z-50">
      <button id="menuSearch"
        class="w-full flex items-center justify-between gap-2 px-4 py-2.5 text-sm text-left text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        <span>Search</span>
        <kbd class="text-xs font-mono opacity-40">âŒƒK</kbd>
      </button>
      <button id="menuSettings"
        class="w-full text-left px-4 py-2.5 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        Settings
      </button>
      <button id="menuTheme"
        class="w-full text-left px-4 py-2.5 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        ğŸŒ™ Dark mode
      </button>
      <hr class="my-1 border-stone-200 dark:border-stone-700">
      <button id="menuEdit"
        class="w-full text-left px-4 py-2.5 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        Edit mode
      </button>
      <button id="menuShortcuts"
        class="w-full text-left px-4 py-2.5 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        âŒ¨ Shortcuts
      </button>
      <button id="menuViewToggle"
        class="w-full text-left px-4 py-2.5 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        â˜° List view
      </button>
      <button id="menuClockToggle"
        class="w-full text-left px-4 py-2.5 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        ğŸ• Show clock
      </button>
      <div class="flex items-center justify-between px-4 py-2">
        <span class="text-xs font-medium uppercase tracking-wide text-stone-400 dark:text-stone-500">Zoom</span>
        <div class="flex items-center gap-1">
          <button id="menuZoomOut"  title="Zoom out (Ctrl âˆ’)" class="w-7 h-7 flex items-center justify-center rounded-md text-sm font-bold text-stone-600 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors">âˆ’</button>
          <button id="menuZoomReset" title="Reset zoom (Ctrl 0)" class="min-w-[3rem] h-7 px-1 text-xs font-mono text-stone-600 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-md transition-colors">100%</button>
          <button id="menuZoomIn"   title="Zoom in (Ctrl +)" class="w-7 h-7 flex items-center justify-center rounded-md text-sm font-bold text-stone-600 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors">+</button>
        </div>
      </div>
      <hr id="menuLogoutSep" class="hidden my-1 border-stone-200 dark:border-stone-700">
      <a id="menuLogout" href="/logout"
        class="hidden block px-4 py-2.5 text-sm text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors">
        Sign out
      </a>
    </div>
  </div>
</header>

<!-- Pinned bar -->
<div id="pinnedSection" class="hidden border-b border-stone-200 dark:border-stone-800">
  <div class="px-6 py-2.5 flex items-center flex-wrap gap-2">
    <span class="text-xs font-semibold uppercase tracking-wider text-stone-400 dark:text-stone-500 mr-1 flex-shrink-0">Pinned</span>
    <div id="pinnedLinks" class="flex flex-wrap gap-2"></div>
  </div>
</div>

<!-- Tag filter bar -->
<div id="tagFilterBar" class="hidden border-b border-stone-200 dark:border-stone-800">
  <div class="px-6 py-2 flex items-center flex-wrap gap-2">
    <span class="text-xs font-semibold uppercase tracking-wider text-stone-400 dark:text-stone-500 mr-1 flex-shrink-0">Filter</span>
    <div id="tagChips" class="flex flex-wrap gap-1.5"></div>
  </div>
</div>

<!-- Main grid -->
<main id="groupsContainer" class="p-6 grid gap-5 items-start transition-opacity duration-150"></main>

<!-- Page-level reload spinner (shown during reload(), hidden when render completes) -->
<div id="pageSpinner" class="hidden fixed inset-0 z-40 pointer-events-none flex items-center justify-center">
  <div class="w-9 h-9 rounded-full border-[3px] border-stone-200 dark:border-stone-700 border-t-indigo-500 animate-spin"></div>
</div>

<!-- Modal overlay -->
<div id="modalOverlay" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true">
  <div id="modalBox" class="relative w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
    <div id="modalContent" class="p-6 overflow-y-auto max-h-[85vh]"></div>
  </div>
</div>

<!-- Search overlay -->
<div id="searchOverlay" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-start justify-center pt-20 px-4" role="dialog" aria-modal="true" aria-label="Quick search">
  <div class="w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden bg-white dark:bg-stone-900 border border-stone-200 dark:border-stone-700/80">
    <!-- Input bar -->
    <div class="flex items-center gap-3 px-4 py-3.5 border-b border-stone-200 dark:border-stone-700/80">
      <svg class="w-4 h-4 flex-shrink-0 text-stone-400 dark:text-stone-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <input id="searchInput" type="text" placeholder="Search linksâ€¦" autocomplete="off"
        class="flex-1 bg-transparent text-sm text-stone-900 dark:text-stone-50 placeholder-stone-400 dark:placeholder-stone-500 outline-none" />
      <span id="searchCount" class="text-xs text-stone-400 dark:text-stone-500 tabular-nums"></span>
      <kbd class="hidden sm:inline-block text-xs font-mono px-1.5 py-0.5 rounded border border-stone-200 dark:border-stone-700 text-stone-400 dark:text-stone-500">Esc</kbd>
    </div>
    <!-- Results -->
    <ul id="searchResults" class="max-h-[26rem] overflow-y-auto" role="listbox"></ul>
    <!-- Footer -->
    <div class="flex items-center gap-4 px-4 py-2 border-t border-stone-100 dark:border-stone-700/60 text-xs text-stone-400 dark:text-stone-500">
      <span><kbd class="font-mono">â†‘â†“</kbd> navigate</span>
      <span><kbd class="font-mono">â†µ</kbd> open</span>
      <span><kbd class="font-mono">Esc</kbd> close</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP LOGIC
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let state = { config: null, editMode: false, activeTag: null };

// Drag-and-drop tracking
let dnd = { type: null, id: null, groupId: null };

// â”€â”€â”€ Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ZOOM_LEVELS = [50, 67, 75, 80, 90, 100, 110, 125, 150, 175, 200];
let currentZoom = parseInt(localStorage.getItem('tbzoom') || '100', 10);
if (!ZOOM_LEVELS.includes(currentZoom)) currentZoom = 100;

function applyZoom(level) {
  currentZoom = level;
  localStorage.setItem('tbzoom', level);
  document.body.style.zoom = level + '%';
  const resetBtn = document.getElementById('menuZoomReset');
  if (resetBtn) resetBtn.textContent = level + '%';
  const outBtn = document.getElementById('menuZoomOut');
  const inBtn  = document.getElementById('menuZoomIn');
  if (outBtn) outBtn.disabled = level <= ZOOM_LEVELS[0];
  if (inBtn)  inBtn.disabled  = level >= ZOOM_LEVELS[ZOOM_LEVELS.length - 1];
}

applyZoom(currentZoom);

// Service status  (linkId â†’ 'up' | 'down')
let statusMap = {};

// Search overlay
let searchOpen = false;
let selectedSearchIdx = -1;
let menuOpen = false;

// â”€â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function api(method, path, body) {
  const res = await fetch(path, {
    method,
    headers: body ? { 'Content-Type': 'application/json' } : {},
    body: body ? JSON.stringify(body) : undefined,
  });
  if (!res.ok) throw new Error(`${method} ${path} â†’ ${res.status}`);
  return res.json();
}

async function reload() {
  const container = document.getElementById('groupsContainer');
  const spinner   = document.getElementById('pageSpinner');
  if (container) container.style.opacity = '0.35';
  if (spinner)   spinner.classList.remove('hidden');
  try {
    state.config = await api('GET', '/api/config');
    render();
    applyStatusDots();
  } finally {
    if (spinner) spinner.classList.add('hidden');
    if (container) {
      // next frame so the rebuilt DOM is painted first, then fade in
      requestAnimationFrame(() => { container.style.opacity = '1'; });
    }
  }
}

// Start status polling: first poll 3 s after page load, then every 30 s
setTimeout(() => { pollStatus(); setInterval(pollStatus, 30_000); }, 3_000);

// â”€â”€â”€ Drag-and-drop helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Drop indicators use box-shadow so they don't affect layout and work inside
// overflow:hidden containers. Indigo-500 (#6366f1) as the indicator colour.
function clearGroupIndicators() {
  document.querySelectorAll('.group-section').forEach(el => {
    el.style.boxShadow = '';
    el.style.outline = '';
    delete el.dataset.dropPos;
  });
}

function clearLinkIndicators() {
  document.querySelectorAll('.link-row').forEach(el => {
    el.style.boxShadow = '';
    delete el.dataset.dropPos;
  });
  // Also clear cross-group section highlights
  document.querySelectorAll('.group-section').forEach(el => {
    el.style.outline = '';
  });
}

// Create a â ¿ drag handle element
function mkHandle(extraClass) {
  const h = document.createElement('span');
  h.textContent = 'â ¿';
  h.title = 'Drag to reorder';
  h.className = `drag-handle select-none flex-shrink-0 leading-none ${extraClass}`;
  // Prevent clicks on the handle from bubbling (e.g. collapsing a group)
  h.addEventListener('click', e => e.stopPropagation());
  return h;
}

// Reorder helper: move item at fromIdx to before/after toIdx (after removal)
function reorder(ids, fromId, targetId, pos) {
  const arr = [...ids];
  const fromIdx = arr.indexOf(fromId);
  arr.splice(fromIdx, 1);
  const toIdx = arr.indexOf(targetId);
  arr.splice(pos === 'top' ? toIdx : toIdx + 1, 0, fromId);
  return arr;
}

// Build canonical widget order from config â€” stored order filtered + any missing appended
function buildWidgetOrder(cfg) {
  const allIds = [];
  if (cfg.showClock) allIds.push('clock');
  (cfg.notes      || []).forEach(n => allIds.push(n.id));
  (cfg.feeds      || []).forEach(f => allIds.push(f.id));
  (cfg.iframes    || []).forEach(i => allIds.push(i.id));
  (cfg.countdowns || []).forEach(c => allIds.push(c.id));
  (cfg.calendars  || []).forEach(c => allIds.push(c.id));
  (cfg.groups     || []).forEach(g => allIds.push(g.id));
  const stored = cfg.widgetOrder || [];
  const seen = new Set();
  const result = stored.filter(id => allIds.includes(id) && !seen.has(id) && seen.add(id));
  allIds.forEach(id => { if (!seen.has(id)) { result.push(id); seen.add(id); } });
  return result;
}

// Clear widget-level DND indicators (box-shadow on [data-widget-id] cards)
function clearWidgetIndicators() {
  document.querySelectorAll('[data-widget-id]').forEach(el => {
    el.style.boxShadow = '';
    delete el.dataset.dropPos;
  });
}

// Clear column-level DND indicators
function clearColumnIndicators() {
  document.querySelectorAll('[data-col-idx]').forEach(el => {
    el.style.boxShadow = '';
    el.style.outline   = '';
    delete el.dataset.colDropPos;
  });
}

// Build 2-D column layout from config.
// Uses stored widgetColumns if present; otherwise distributes round-robin into 4 columns.
// Always reconciles against the canonical widget ID list so stale IDs are dropped and
// new ones (just created) are placed in addingToColIdx.
let addingToColIdx = 0;
function buildWidgetColumns(cfg) {
  const allIds = buildWidgetOrder(cfg);
  const allIdsSet = new Set(allIds);

  let cols = (cfg.widgetColumns || []).length > 0
    ? (cfg.widgetColumns || []).map(c => c.filter(id => allIdsSet.has(id)))
    : null;

  if (!cols) {
    // Initial layout: distribute round-robin across 4 columns
    cols = [[], [], [], []];
    allIds.forEach((id, i) => cols[i % 4].push(id));
    return cols;
  }

  // Place any new IDs (not yet in any column) into addingToColIdx
  const storedIds = new Set(cols.flat());
  allIds.filter(id => !storedIds.has(id)).forEach(id => {
    const t = Math.max(0, Math.min(addingToColIdx, cols.length - 1));
    cols[t].push(id);
  });

  return cols;
}

// Move widget fromId into toColIdx before/after toId (or append when toId is null)
function moveWidget(cols, fromId, toColIdx, toId, pos) {
  const newCols = cols.map(c => c.filter(id => id !== fromId));
  const col = newCols[toColIdx];
  if (toId === null) {
    col.push(fromId);
  } else {
    const idx = col.indexOf(toId);
    col.splice(idx === -1 ? col.length : pos === 'top' ? idx : idx + 1, 0, fromId);
  }
  return newCols;
}

// Move column fromIdx to left/right of toIdx
function moveColumn(cols, fromIdx, toIdx, pos) {
  if (fromIdx === toIdx) return cols;
  const n = [...cols];
  const [removed] = n.splice(fromIdx, 1);
  // toIdx references the original array; after splice, positions shift
  const target = cols[toIdx];
  let at = n.indexOf(target);
  if (at === -1) at = n.length;
  if (pos === 'right') at++;
  n.splice(Math.max(0, Math.min(at, n.length)), 0, removed);
  return n;
}

// Persist column layout: update state optimistically + save to server
async function saveColumns(newCols) {
  state.config.widgetColumns = newCols;
  render();
  await api('PUT', '/api/widgetColumns', { columns: newCols });
}

// Attach widget drag-and-drop drop-target handlers to a card (edit mode only)
function attachWidgetDnd(card, widgetId) {
  card.addEventListener('dragover', e => {
    if (dnd.type !== 'widget' || dnd.id === widgetId) return;
    e.preventDefault();
    clearWidgetIndicators();
    const rect = card.getBoundingClientRect();
    const pos = e.clientY < rect.top + rect.height / 2 ? 'top' : 'bottom';
    card.style.boxShadow = pos === 'top' ? '0 -3px 0 0 #6366f1' : '0 3px 0 0 #6366f1';
    card.dataset.dropPos = pos;
  });

  card.addEventListener('dragleave', e => {
    if (!card.contains(e.relatedTarget)) {
      card.style.boxShadow = '';
      delete card.dataset.dropPos;
    }
  });

  card.addEventListener('drop', async e => {
    e.preventDefault();
    e.stopPropagation(); // don't bubble to column drop handler
    if (dnd.type !== 'widget' || dnd.id === widgetId) return;
    const pos = card.dataset.dropPos || 'bottom';
    clearWidgetIndicators();
    const colEl = card.closest('[data-col-idx]');
    const toColIdx = colEl ? parseInt(colEl.dataset.colIdx) : 0;
    const newCols = moveWidget(buildWidgetColumns(state.config), dnd.id, toColIdx, widgetId, pos);
    dnd = { type: null };
    await saveColumns(newCols);
  });
}

// â”€â”€â”€ Theme helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function applyTheme(dark) {
  document.documentElement.classList.toggle('dark', dark);
  const btn = document.getElementById('menuTheme');
  if (btn) btn.textContent = dark ? 'â˜€ Light mode' : 'ğŸŒ™ Dark mode';
}

function applyBase(palette) {
  const t = TOPBAR[palette] || TOPBAR.stone;
  const topbar = document.getElementById('topbar');
  topbar.className = `sticky top-0 z-30 flex items-center justify-between px-6 py-3 shadow-sm border-b transition-colors ${t.bar} ${t.text}`;

  const me = document.getElementById('menuEdit');
  if (me) {
    if (state.editMode) {
      me.textContent = 'âœ“ Edit mode';
      me.className = 'w-full text-left px-4 py-2.5 text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors';
    } else {
      me.textContent = 'Edit mode';
      me.className = 'w-full text-left px-4 py-2.5 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-stone-700/60 transition-colors';
    }
  }

  const vt = document.getElementById('menuViewToggle');
  if (vt) vt.textContent = state.config && state.config.viewMode === 'list' ? 'âŠ Grid view' : 'â˜° List view';

  const ct = document.getElementById('menuClockToggle');
  if (ct) ct.textContent = state.config && state.config.showClock ? 'ğŸ• Hide clock' : 'ğŸ• Show clock';

  const meta = document.getElementById('metaThemeColor');
  if (meta) meta.content = PALETTE_HEX[palette] || '#57534e';
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function render() {
  const cfg = state.config;
  const b = FIXED;
  const isList = cfg.viewMode === 'list';

  document.title = cfg.title || 'Tailboard';
  document.getElementById('dashTitle').textContent = cfg.title || 'Tailboard';
  applyTheme(cfg.darkMode);
  applyBase(cfg.basePalette);

  const container = document.getElementById('groupsContainer');
  container.innerHTML = '';

  if (isList) {
    // List mode: single flat column with CSS columns-1 (unchanged)
    container.className = 'p-6 columns-1 gap-5';
    buildWidgetOrder(cfg).forEach(id => {
      const card = resolveCard(id, cfg);
      if (!card) return;
      if (state.activeTag && !state.editMode) {
        const g = (cfg.groups || []).find(x => x.id === id);
        if (g && !g.links.some(l => (l.tags || []).includes(state.activeTag))) return;
      }
      card.dataset.widgetId = id;
      card.classList.add('break-inside-avoid', 'mb-5');
      if (state.editMode) attachWidgetDnd(card, id);
      container.appendChild(card);
    });
    if (state.editMode) {
      const addBtn = document.createElement('button');
      addBtn.className = `rounded-xl border-2 border-dashed border-stone-300 dark:border-stone-600 p-6 text-sm font-medium ${FIXED.sub} hover:bg-black/5 dark:hover:bg-white/5 transition-colors w-full break-inside-avoid mb-5`;
      addBtn.innerHTML = '<span class="text-2xl block mb-1">+</span>Add widget';
      addBtn.onclick = openAddWidgetModal;
      container.appendChild(addBtn);
    }
  } else {
    // Grid mode: Trello-style explicit column containers
    container.className = 'p-6 flex gap-5 items-start overflow-x-auto';
    const cols = buildWidgetColumns(cfg);

    cols.forEach((colItems, colIdx) => {
      const colEl = document.createElement('div');
      colEl.className = 'flex-1 min-w-[220px] flex flex-col gap-4';
      colEl.dataset.colIdx = colIdx;

      // â”€â”€ Column header (edit mode only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (state.editMode) {
        const hdr = document.createElement('div');
        hdr.className = `flex items-center gap-2 px-3 py-2 rounded-xl border ${FIXED.card} text-xs font-medium ${FIXED.sub} select-none cursor-default`;

        // Column drag handle
        const handle = mkHandle(`${FIXED.sub} cursor-grab active:cursor-grabbing`);
        handle.draggable = true;
        handle.addEventListener('dragstart', e => {
          e.stopPropagation();
          dnd = { type: 'column', idx: colIdx };
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', `col-${colIdx}`);
          setTimeout(() => { colEl.style.opacity = '0.4'; }, 0);
        });
        handle.addEventListener('dragend', () => {
          colEl.style.opacity = '';
          clearColumnIndicators();
          dnd = { type: null };
        });
        hdr.appendChild(handle);

        const label = document.createElement('span');
        label.className = 'flex-1';
        label.textContent = `Column ${colIdx + 1}`;
        hdr.appendChild(label);

        const countBadge = document.createElement('span');
        countBadge.className = 'opacity-50';
        countBadge.textContent = colItems.length;
        hdr.appendChild(countBadge);

        // Delete column button
        const delBtn = mkBtn('âœ•', 'Remove column', `opacity-50 hover:opacity-100 transition-opacity px-1`, async () => {
          const currentCols = buildWidgetColumns(state.config);
          if (currentCols.length <= 1) return;
          const newCols = currentCols.map((c, i) => i === colIdx ? [] : [...c]);
          // Move orphaned items to column 0
          currentCols[colIdx].forEach(id => newCols[0].push(id));
          const filtered = newCols.filter((_, i) => i !== colIdx);
          await saveColumns(filtered);
        });
        hdr.appendChild(delBtn);

        colEl.appendChild(hdr);
      }

      // â”€â”€ Column-level drag-and-drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (state.editMode) {
        colEl.addEventListener('dragover', e => {
          // Reordering columns
          if (dnd.type === 'column' && dnd.idx !== colIdx) {
            e.preventDefault();
            clearColumnIndicators();
            const rect = colEl.getBoundingClientRect();
            const pos = e.clientX < rect.left + rect.width / 2 ? 'left' : 'right';
            colEl.style.boxShadow = pos === 'left' ? '-3px 0 0 0 #6366f1' : '3px 0 0 0 #6366f1';
            colEl.dataset.colDropPos = pos;
            return;
          }
          // Widget onto empty column space (not onto a card)
          if (dnd.type === 'widget' && !e.target.closest('[data-widget-id]')) {
            e.preventDefault();
            clearColumnIndicators();
            colEl.style.outline = '2px dashed #6366f1';
            colEl.style.outlineOffset = '4px';
          }
        });

        colEl.addEventListener('dragleave', e => {
          if (!colEl.contains(e.relatedTarget)) clearColumnIndicators();
        });

        colEl.addEventListener('drop', async e => {
          clearColumnIndicators();
          colEl.style.opacity = '';

          if (dnd.type === 'column' && dnd.idx !== colIdx) {
            e.preventDefault();
            const pos = colEl.dataset.colDropPos || 'right';
            const newCols = moveColumn(buildWidgetColumns(state.config), dnd.idx, colIdx, pos);
            dnd = { type: null };
            await saveColumns(newCols);
            return;
          }

          if (dnd.type === 'widget' && !e.target.closest('[data-widget-id]')) {
            e.preventDefault();
            const newCols = moveWidget(buildWidgetColumns(state.config), dnd.id, colIdx, null, 'append');
            dnd = { type: null };
            await saveColumns(newCols);
          }
        });
      }

      // â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      colItems.forEach(id => {
        const card = resolveCard(id, cfg);
        if (!card) return;
        if (state.activeTag && !state.editMode) {
          const g = (cfg.groups || []).find(x => x.id === id);
          if (g && !g.links.some(l => (l.tags || []).includes(state.activeTag))) return;
        }
        card.dataset.widgetId = id;
        if (state.editMode) attachWidgetDnd(card, id);
        colEl.appendChild(card);
      });

      // â”€â”€ Add widget button (per column, edit mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (state.editMode) {
        const addBtn = document.createElement('button');
        addBtn.className = `rounded-xl border-2 border-dashed border-stone-300 dark:border-stone-600 py-3 text-sm font-medium ${FIXED.sub} hover:bg-black/5 dark:hover:bg-white/5 transition-colors w-full`;
        addBtn.innerHTML = '+ Add';
        addBtn.onclick = () => { addingToColIdx = colIdx; openAddWidgetModal(); };
        colEl.appendChild(addBtn);
      }

      container.appendChild(colEl);
    });

    // Add column button (edit mode)
    if (state.editMode) {
      const addColBtn = document.createElement('button');
      addColBtn.className = `flex-shrink-0 w-14 self-start rounded-xl border-2 border-dashed border-stone-300 dark:border-stone-600 py-5 text-xs font-medium ${FIXED.sub} hover:bg-black/5 dark:hover:bg-white/5 transition-colors flex flex-col items-center gap-1`;
      addColBtn.title = 'Add column';
      addColBtn.innerHTML = '<span class="text-lg leading-none">+</span><span>Col</span>';
      addColBtn.onclick = async () => {
        await saveColumns([...buildWidgetColumns(state.config), []]);
      };
      container.appendChild(addColBtn);
    }
  }

  renderPinned();
  renderTagFilterBar();
  applyBackground(cfg.background);
  applyCustomCss(cfg.customCss || '');
  document.documentElement.classList.toggle('sharp', !!cfg.sharpCorners);
  (cfg.feeds     || []).forEach(f => fetchRss(f));
  (cfg.calendars || []).forEach(c => fetchIcal(c));

  if (cfg.showClock) {
    requestAnimationFrame(updateClock);
    fetchWeather();
  }
}

// Resolve a widget ID to its rendered card element (or null)
function resolveCard(id, cfg) {
  if (id === 'clock' && cfg.showClock)                                    return renderClockCard();
  const n = (cfg.notes      || []).find(x => x.id === id); if (n) return renderNoteCard(n);
  const f = (cfg.feeds      || []).find(x => x.id === id); if (f) return renderFeedCard(f);
  const i = (cfg.iframes    || []).find(x => x.id === id); if (i) return renderIframeCard(i);
  const c = (cfg.countdowns || []).find(x => x.id === id); if (c) return renderCountdownCard(c);
  const ca= (cfg.calendars  || []).find(x => x.id === id); if (ca) return renderCalendarCard(ca);
  const g = (cfg.groups     || []).find(x => x.id === id); if (g) return renderGroupCard(g);
  return null;
}

function applyCustomCss(css) {
  let el = document.getElementById('customCssTag');
  if (!el) { el = document.createElement('style'); el.id = 'customCssTag'; document.head.appendChild(el); }
  el.textContent = css;
}

function renderTagFilterBar() {
  const cfg = state.config;
  const allTags = [...new Set((cfg.groups || []).flatMap(g => g.links.flatMap(l => l.tags || [])))].sort();
  const bar   = document.getElementById('tagFilterBar');
  const chips = document.getElementById('tagChips');
  if (!allTags.length) { bar.classList.add('hidden'); state.activeTag = null; return; }
  bar.classList.remove('hidden');
  chips.innerHTML = '';

  // "All" chip â€” always first
  const allBtn = document.createElement('button');
  allBtn.textContent = 'All';
  allBtn.title = 'Show all groups';
  const isAll = !state.activeTag;
  allBtn.className = `text-xs px-2.5 py-1 rounded-full font-medium transition-colors ${
    isAll ? 'bg-indigo-600 text-white' : 'bg-stone-100 dark:bg-stone-800 text-stone-600 dark:text-stone-300 hover:bg-stone-200 dark:hover:bg-stone-700'
  }`;
  allBtn.onclick = () => { state.activeTag = null; render(); };
  chips.appendChild(allBtn);

  allTags.forEach(tag => {
    const btn = document.createElement('button');
    const active = state.activeTag === tag;
    btn.textContent = tag;
    btn.title = `Filter by "${tag}"`;
    btn.className = `text-xs px-2.5 py-1 rounded-full font-medium transition-colors ${
      active ? 'bg-indigo-600 text-white' : 'bg-stone-100 dark:bg-stone-800 text-stone-600 dark:text-stone-300 hover:bg-stone-200 dark:hover:bg-stone-700'
    }`;
    btn.onclick = () => { state.activeTag = active ? null : tag; render(); };
    chips.appendChild(btn);
  });

  // Group match count when a tag is active
  if (state.activeTag) {
    const n = (cfg.groups || []).filter(g => g.links.some(l => (l.tags || []).includes(state.activeTag))).length;
    const count = document.createElement('span');
    count.className = 'text-xs text-stone-400 dark:text-stone-500 ml-1 self-center';
    count.textContent = `${n} group${n !== 1 ? 's' : ''}`;
    chips.appendChild(count);
  }
}

// â”€â”€â”€ Group card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderGroupCard(group) {
  const cfg = state.config;
  const b = FIXED;
  const isList = cfg.viewMode === 'list';
  const acc = ACCENT[group.accent] || ACCENT.slate;

  const section = document.createElement('div');
  section.className = `group-section rounded-xl overflow-hidden border shadow-md transition-opacity duration-150 ${b.card}`;
  section.dataset.groupId = group.id;

  // Cross-group link drop target (widget DND handled by attachWidgetDnd in unified loop)
  if (state.editMode) {
    section.addEventListener('dragover', e => {
      if (dnd.type === 'link' && dnd.groupId !== group.id) {
        e.preventDefault();
        e.stopPropagation();
        clearLinkIndicators();
        const dragged = document.querySelector(`.link-row[data-link-id="${dnd.id}"]`);
        if (dragged) dragged.style.opacity = '0.4';
        section.style.outline = '2px dashed #6366f1';
        section.style.outlineOffset = '-3px';
      }
    });

    section.addEventListener('dragleave', e => {
      if (!section.contains(e.relatedTarget)) {
        section.style.outline = '';
      }
    });

    section.addEventListener('drop', async e => {
      e.preventDefault();
      if (dnd.type === 'link' && dnd.groupId !== group.id) {
        clearLinkIndicators();
        const { id: linkId, groupId: sourceGroupId } = dnd;
        dnd = { type: null };
        await api('POST', '/api/links/move', { linkId, sourceGroupId, targetGroupId: group.id });
        await reload();
      }
    });
  }

  // â”€â”€ Group header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const header = document.createElement('div');
  header.className = `flex items-center justify-between px-4 py-2.5 cursor-pointer select-none ${acc.header}`;

  const leftSide = document.createElement('div');
  leftSide.className = 'flex items-center gap-2 min-w-0 flex-1';

  if (state.editMode) {
    const handle = mkHandle('text-white/60 hover:text-white/90 text-base');
    handle.draggable = true;
    handle.addEventListener('dragstart', e => {
      e.stopPropagation();
      dnd = { type: 'widget', id: group.id };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', group.id);
      setTimeout(() => { section.style.opacity = '0.4'; }, 0);
    });
    handle.addEventListener('dragend', () => {
      section.style.opacity = '';
      clearWidgetIndicators();
      dnd = { type: null };
    });
    leftSide.appendChild(handle);
  }

  if (group.icon) {
    const gIcon = document.createElement('img');
    gIcon.src = `/api/icon/${group.icon}`;
    gIcon.alt = '';
    gIcon.className = 'w-5 h-5 object-contain flex-shrink-0 opacity-90';
    gIcon.onerror = () => gIcon.remove();
    leftSide.appendChild(gIcon);
  }

  const titleSpan = document.createElement('span');
  titleSpan.className = 'font-semibold text-sm tracking-wide truncate';
  titleSpan.textContent = group.name;
  leftSide.appendChild(titleSpan);

  const rightControls = document.createElement('div');
  rightControls.className = 'flex items-center gap-1 flex-shrink-0';

  if (state.editMode) {
    rightControls.appendChild(mkBtn('â‡…', 'Sort Aâ€“Z', 'text-white/70 hover:text-white text-base px-1', async e => {
      e.stopPropagation();
      const sorted = [...group.links].sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
      await api('PUT', `/api/groups/${group.id}/links/reorder`, { order: sorted.map(l => l.id) });
      await reload();
    }));
    rightControls.appendChild(mkBtn('âœ', 'Edit group', 'text-white/80 hover:text-white text-base px-1', e => {
      e.stopPropagation();
      openGroupModal(group);
    }));
    rightControls.appendChild(mkBtn('âœ•', 'Delete group', 'text-white/70 hover:text-white text-base px-1', async e => {
      e.stopPropagation();
      if (!confirm(`Delete group "${group.name}" and all its links?`)) return;
      await api('DELETE', `/api/groups/${group.id}`);
      await reload();
    }));
  }

  const chevron = document.createElement('span');
  chevron.className = 'ml-1 text-white/80 text-xs';
  chevron.textContent = group.collapsed ? 'â–¶' : 'â–¾';
  rightControls.appendChild(chevron);

  header.appendChild(leftSide);
  header.appendChild(rightControls);
  header.addEventListener('click', async () => {
    await api('PUT', `/api/groups/${group.id}`, { collapsed: !group.collapsed });
    await reload();
  });
  section.appendChild(header);

  // â”€â”€ Links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const linksWrap = document.createElement('div');
  linksWrap.className = group.collapsed ? 'hidden' : '';

  if (group.links.length > 0) {
    const grid = document.createElement('div');
    grid.className = 'flex flex-col divide-y divide-black/[0.06] dark:divide-white/[0.08]';

    group.links.forEach((link) => {
      const row = document.createElement('div');
      row.className = `link-row flex items-center gap-3 ${isList ? 'px-2 py-1.5' : 'px-3 py-2.5'} ${acc.border} transition-opacity duration-100`;
      row.dataset.linkId = link.id;

      if (state.editMode) {
        // Link drag handle
        const handle = mkHandle(`text-base opacity-30 hover:opacity-70 ${b.sub}`);
        handle.draggable = true;
        handle.addEventListener('dragstart', e => {
          e.stopPropagation();
          dnd = { type: 'link', id: link.id, groupId: group.id };
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', link.id);
          e.dataTransfer.setDragImage(row, 20, 10);
          setTimeout(() => { row.style.opacity = '0.4'; }, 0);
        });
        handle.addEventListener('dragend', () => {
          clearLinkIndicators();
          dnd = { type: null };
        });
        row.appendChild(handle);

        // Link drop-target events â€” accepts same-group reorder AND cross-group moves
        row.addEventListener('dragover', e => {
          if (dnd.type !== 'link' || dnd.id === link.id) return;
          e.preventDefault();
          e.stopPropagation();
          clearLinkIndicators();
          const dragged = document.querySelector(`.link-row[data-link-id="${dnd.id}"]`);
          if (dragged) dragged.style.opacity = '0.4';
          const rect = row.getBoundingClientRect();
          const pos = e.clientY < rect.top + rect.height / 2 ? 'top' : 'bottom';
          row.style.boxShadow = pos === 'top' ? '0 -2px 0 0 #6366f1' : '0 2px 0 0 #6366f1';
          row.dataset.dropPos = pos;
        });

        row.addEventListener('dragleave', e => {
          if (!row.contains(e.relatedTarget)) {
            row.style.boxShadow = '';
            delete row.dataset.dropPos;
          }
        });

        row.addEventListener('drop', async e => {
          e.preventDefault();
          e.stopPropagation();
          if (dnd.type !== 'link' || dnd.id === link.id) return;
          const pos = row.dataset.dropPos || 'bottom';
          clearLinkIndicators();

          if (dnd.groupId === group.id) {
            const order = reorder(group.links.map(l => l.id), dnd.id, link.id, pos);
            const gid = group.id;
            dnd = { type: null };
            await api('PUT', `/api/groups/${gid}/links/reorder`, { order });
          } else {
            const { id: linkId, groupId: sourceGroupId } = dnd;
            dnd = { type: null };
            await api('POST', '/api/links/move', {
              linkId,
              sourceGroupId,
              targetGroupId: group.id,
              targetLinkId: link.id,
              position: pos === 'top' ? 'before' : 'after',
            });
          }
          await reload();
        });
      } else {
        row.classList.add('cursor-pointer', 'hover:bg-black/5', 'dark:hover:bg-white/5');
        row.tabIndex = 0;
        row.addEventListener('click', () => window.open(link.url, '_blank', 'noopener'));
        row.addEventListener('keydown', e => { if (e.key === 'Enter') window.open(link.url, '_blank', 'noopener'); });
      }

      // Icon (includes status dot)
      const iconWrap = mkIconWrap(link, isList);

      // Text
      const textWrap = document.createElement('div');
      textWrap.className = 'flex-1 min-w-0';
      const nameEl = document.createElement('div');
      nameEl.className = `text-sm font-medium truncate ${b.text}`;
      nameEl.textContent = link.name;
      if (link.hotkey) {
        const badge = document.createElement('span');
        badge.className = 'ml-1 text-xs font-mono opacity-40 flex-shrink-0';
        badge.textContent = `[${link.hotkey.toUpperCase()}]`;
        nameEl.appendChild(badge);
      }
      textWrap.appendChild(nameEl);
      if (link.description && !isList) {
        const desc = document.createElement('div');
        desc.className = `text-xs truncate ${b.sub}`;
        desc.textContent = link.description;
        textWrap.appendChild(desc);
      }
      if ((link.tags || []).length && !isList) {
        const tagRow = document.createElement('div');
        tagRow.className = 'flex flex-wrap gap-1 mt-0.5';
        (link.tags || []).forEach(tag => {
          const chip = document.createElement('span');
          chip.textContent = tag;
          const isActive = state.activeTag === tag;
          chip.className = `text-[10px] px-1.5 py-0.5 rounded-full font-medium cursor-pointer transition-colors ${
            isActive ? 'bg-indigo-600 text-white' : 'bg-stone-100 dark:bg-stone-700 text-stone-500 dark:text-stone-400 hover:bg-stone-200 dark:hover:bg-stone-600'
          }`;
          chip.onclick = e => { e.stopPropagation(); state.activeTag = isActive ? null : tag; render(); };
          tagRow.appendChild(chip);
        });
        textWrap.appendChild(tagRow);
      }

      row.appendChild(iconWrap);
      row.appendChild(textWrap);

      if (state.editMode) {
        const editControls = document.createElement('div');
        editControls.className = 'flex items-center gap-1 flex-shrink-0';
        editControls.appendChild(mkBtn(
          link.pinned ? 'â˜…' : 'â˜†',
          link.pinned ? 'Unpin' : 'Pin to top',
          `text-xs px-1 rounded hover:opacity-100 opacity-60 ${link.pinned ? 'text-yellow-500' : b.sub}`,
          async () => {
            await api('PUT', `/api/groups/${group.id}/links/${link.id}`, { pinned: !link.pinned });
            await reload();
          }
        ));
        editControls.appendChild(mkBtn('âœ', 'Edit link', `text-xs px-1 rounded ${b.sub} hover:opacity-100 opacity-60`, () => openLinkModal(group.id, link)));
        editControls.appendChild(mkBtn('âœ•', 'Delete link', 'text-xs px-1 rounded text-red-400 hover:opacity-100 opacity-60', async () => {
          if (!confirm(`Delete link "${link.name}"?`)) return;
          await api('DELETE', `/api/groups/${group.id}/links/${link.id}`);
          await reload();
        }));
        row.appendChild(editControls);
      }

      grid.appendChild(row);
    });

    linksWrap.appendChild(grid);
  } else if (!state.editMode) {
    const empty = document.createElement('p');
    empty.className = `px-4 py-3 text-xs ${b.sub} italic`;
    empty.textContent = 'No links yet.';
    linksWrap.appendChild(empty);
  }

  if (state.editMode) {
    const addLinkBtn = document.createElement('button');
    addLinkBtn.className = `w-full text-left px-4 py-2.5 text-xs font-medium border-t border-black/5 dark:border-white/5 ${b.sub} hover:bg-black/5 dark:hover:bg-white/5 transition-colors`;
    addLinkBtn.textContent = '+ Add link';
    addLinkBtn.onclick = () => openLinkModal(group.id);
    linksWrap.appendChild(addLinkBtn);
  }

  section.appendChild(linksWrap);
  return section;
}

// â”€â”€â”€ Clock card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderClockCard() {
  const cfg = state.config;
  const t   = TOPBAR[cfg.basePalette] || TOPBAR.stone;
  const card = document.createElement('div');
  card.className = `group-section rounded-xl overflow-hidden border shadow-md ${FIXED.card}`;

  // Header
  const hdr = document.createElement('div');
  hdr.className = `flex items-center justify-between px-4 py-2.5 ${t.bar} ${t.text}`;
  const hTitle = document.createElement('span');
  hTitle.className = 'font-semibold text-sm tracking-wide flex-1';
  hTitle.textContent = 'Clock';
  hdr.appendChild(hTitle);
  hdr.appendChild(mkBtn('âš™', 'Weather settings', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => openWeatherModal()));
  if (state.editMode) {
    const handle = mkHandle('text-white/60 hover:text-white/90 text-base');
    handle.draggable = true;
    handle.addEventListener('dragstart', e => {
      e.stopPropagation();
      dnd = { type: 'widget', id: 'clock' };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', 'clock');
      setTimeout(() => { card.style.opacity = '0.4'; }, 0);
    });
    handle.addEventListener('dragend', () => {
      card.style.opacity = '';
      clearWidgetIndicators();
      dnd = { type: null };
    });
    hdr.insertBefore(handle, hTitle);
  }
  card.appendChild(hdr);

  // Body
  const body = document.createElement('div');
  body.className = 'px-4 py-5 text-center';
  const timeEl = document.createElement('div');
  timeEl.id = 'clockCardTime';
  timeEl.className = `${WIDGET.time} ${FIXED.text}`;
  body.appendChild(timeEl);
  const dateEl = document.createElement('div');
  dateEl.id = 'clockCardDate';
  dateEl.className = `${WIDGET.date} ${FIXED.sub}`;
  body.appendChild(dateEl);
  const wxEl = document.createElement('div');
  wxEl.id = 'clockCardWeather';
  wxEl.className = 'mt-3';
  body.appendChild(wxEl);
  card.appendChild(body);
  return card;
}

// â”€â”€â”€ Weather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function fetchWeather() {
  const el = document.getElementById('clockCardWeather');
  if (el) { el.innerHTML = ''; el.appendChild(mkCardSpinner()); }
  try {
    const res = await fetch('/api/weather');
    if (res.status === 204) { renderWeatherCard(null); return; }
    if (!res.ok) throw new Error(res.status);
    renderWeatherCard(await res.json());
  } catch { renderWeatherCard(null); }
}

function renderWeatherCard(data) {
  const el = document.getElementById('clockCardWeather');
  if (!el) return;
  if (!data) { el.innerHTML = ''; return; }
  const unit = data.units === 'imperial' ? 'Â°F' : 'Â°C';
  el.innerHTML = `
    <div class="flex items-center justify-center gap-2 mt-2">
      <img src="https://openweathermap.org/img/wn/${data.icon}@2x.png"
           class="w-10 h-10 flex-shrink-0" alt="" onerror="this.remove()">
      <div>
        <div class="text-2xl font-semibold ${FIXED.text}">${data.temp}${unit}</div>
        <div class="text-xs capitalize ${FIXED.sub}">${data.description}</div>
      </div>
    </div>
    <div class="text-xs mt-1 ${FIXED.sub}">
      ${data.city} &middot; feels ${data.feels}${unit} &middot; ${data.humidity}% humidity
    </div>`;
}

function openWeatherModal() {
  const cfg = state.config;
  const wx  = cfg.weather || {};
  const b   = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = 'Weather settings';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('OpenWeather API key', b.sub));
  const apiInput = document.createElement('input');
  apiInput.type = 'password';
  apiInput.value = wx.apiKey || '';
  apiInput.placeholder = 'Paste your API keyâ€¦';
  apiInput.className = `w-full px-3 py-2 rounded-lg text-sm border ${b.card} ${b.text} focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all`;
  wrap.appendChild(apiInput);

  const hint = document.createElement('p');
  hint.className = `text-xs mt-1 mb-3 ${b.sub}`;
  hint.innerHTML = 'Free key at <a href="https://home.openweathermap.org/users/sign_up" target="_blank" rel="noopener" class="underline">openweathermap.org</a>. Key stays on the server.';
  wrap.appendChild(hint);

  const cityLabel = mkLabel('City', b.sub);
  cityLabel.className += ' mt-2 block';
  wrap.appendChild(cityLabel);
  const cityInput = mkInput(wx.city || '', 'e.g. London, New York, Tokyo', b);
  wrap.appendChild(cityInput);

  const unitsLabel = mkLabel('Units', b.sub);
  unitsLabel.className += ' mt-4 block';
  wrap.appendChild(unitsLabel);

  let selectedUnits = wx.units === 'imperial' ? 'imperial' : 'metric';
  const piBase   = 'px-4 py-1.5 rounded-lg text-sm border transition-colors';
  const piActive = 'bg-indigo-600 text-white border-indigo-600';
  const piIdle   = `border-stone-300 dark:border-stone-600 ${b.text} hover:bg-stone-100 dark:hover:bg-stone-700`;
  const unitsRow = document.createElement('div');
  unitsRow.className = 'flex gap-2 mt-1';
  [{ v: 'metric', l: 'Metric Â°C' }, { v: 'imperial', l: 'Imperial Â°F' }].forEach(({ v, l }) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = l;
    btn.dataset.units = v;
    btn.className = `${piBase} ${v === selectedUnits ? piActive : piIdle}`;
    btn.addEventListener('click', () => {
      selectedUnits = v;
      unitsRow.querySelectorAll('button').forEach(b2 => {
        b2.className = `${piBase} ${b2.dataset.units === selectedUnits ? piActive : piIdle}`;
      });
    });
    unitsRow.appendChild(btn);
  });
  wrap.appendChild(unitsRow);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);

  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.textContent = 'Save';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    await api('PUT', '/api/config', {
      weather: { apiKey: apiInput.value.trim(), city: cityInput.value.trim(), units: selectedUnits },
    });
    state.config = await api('GET', '/api/config');
    closeModal();
    render();
    fetchWeather();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);

  openModal(wrap);
  apiInput.focus();
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function mkBtn(label, title, cls, handler) {
  const btn = document.createElement('button');
  btn.textContent = label;
  btn.title = title;
  btn.className = cls;
  btn.addEventListener('click', handler);
  return btn;
}

function mkCardSpinner() {
  const wrap = document.createElement('div');
  wrap.className = 'flex items-center justify-center py-6';
  const ring = document.createElement('div');
  ring.className = 'w-5 h-5 rounded-full border-2 border-stone-200 dark:border-stone-700 border-t-indigo-500 animate-spin';
  wrap.appendChild(ring);
  return wrap;
}

function mkPlaceholderIcon(colorClass) {
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', '0 0 24 24');
  svg.setAttribute('class', `w-6 h-6 ${colorClass}`);
  svg.setAttribute('fill', 'currentColor');
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', 'M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2Zm0 3a7 7 0 1 1 0 14A7 7 0 0 1 12 5Zm-1 4h2v5h-2V9Zm0 6h2v2h-2v-2Z');
  svg.appendChild(path);
  return svg;
}

// â”€â”€â”€ Icon wrap helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Returns a position:relative wrapper containing the icon + status dot. */
function mkIconWrap(link, compact) {
  const outer = document.createElement('div');
  outer.className = `relative flex-shrink-0 ${compact ? 'w-7 h-7' : 'w-9 h-9'}`;

  const inner = document.createElement('div');
  inner.className = 'w-full h-full flex items-center justify-center';
  const iconBgHex = ICON_BG_MAP[link.iconBg || 'none'];
  if (iconBgHex) {
    inner.style.cssText = `border-radius:22%;background-color:${iconBgHex};padding:5px;`;
  }
  if (link.icon) {
    const img = document.createElement('img');
    img.src = `/api/icon/${link.icon}`;
    img.alt = link.name;
    img.className = 'w-full h-full object-contain';
    img.onerror = () => img.replaceWith(mkPlaceholderIcon(FIXED.sub));
    inner.appendChild(img);
  } else {
    inner.appendChild(mkPlaceholderIcon(FIXED.sub));
  }
  outer.appendChild(inner);

  const dot = document.createElement('span');
  dot.dataset.statusId = link.id;
  dot.className = 'absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full ring-2 ring-white dark:ring-stone-800 bg-stone-300 dark:bg-stone-600';
  outer.appendChild(dot);

  return outer;
}

// â”€â”€â”€ Status dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function applyStatusDots() {
  document.querySelectorAll('[data-status-id]').forEach(dot => {
    const s = statusMap[dot.dataset.statusId];
    dot.className = 'absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full ring-2 ring-white dark:ring-stone-800';
    if      (s === 'up')   dot.className += ' bg-green-400';
    else if (s === 'down') dot.className += ' bg-red-500';
    else                   dot.className += ' bg-stone-300 dark:bg-stone-600';
  });
}

async function pollStatus() {
  try {
    statusMap = await api('GET', '/api/status');
    applyStatusDots();
  } catch { /* best-effort */ }
}

// â”€â”€â”€ Pinned bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderPinned() {
  const section   = document.getElementById('pinnedSection');
  const container = document.getElementById('pinnedLinks');
  if (!section || !container) return;

  const allPinned = (state.config.groups || []).flatMap(g =>
    g.links.filter(l => l.pinned).map(l => ({ link: l, group: g }))
  );

  if (allPinned.length === 0 && !state.editMode) {
    section.classList.add('hidden');
    return;
  }
  section.classList.remove('hidden');
  container.innerHTML = '';

  allPinned.forEach(({ link, group }) => {
    if (state.editMode) {
      const chip = document.createElement('div');
      chip.className = `flex items-center gap-1.5 pl-2.5 pr-1 py-1 rounded-lg text-sm border ${FIXED.card} ${FIXED.text}`;
      if (link.icon) {
        const img = document.createElement('img');
        img.src = `/api/icon/${link.icon}`;
        img.className = 'w-4 h-4 object-contain flex-shrink-0';
        img.onerror = () => img.remove();
        chip.appendChild(img);
      }
      const name = document.createElement('span');
      name.className = 'text-sm';
      name.textContent = link.name;
      chip.appendChild(name);
      const unpin = mkBtn('âœ•', 'Unpin', 'ml-1 text-xs opacity-40 hover:opacity-90 hover:text-red-500 transition-colors', async () => {
        await api('PUT', `/api/groups/${group.id}/links/${link.id}`, { pinned: false });
        await reload();
      });
      chip.appendChild(unpin);
      container.appendChild(chip);
    } else {
      const chip = document.createElement('a');
      chip.href = link.url;
      chip.target = '_blank';
      chip.rel = 'noopener';
      chip.className = `flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium border ${FIXED.card} ${FIXED.text} hover:bg-black/5 dark:hover:bg-white/5 transition-colors`;
      if (link.icon) {
        const img = document.createElement('img');
        img.src = `/api/icon/${link.icon}`;
        img.className = 'w-4 h-4 object-contain flex-shrink-0';
        img.onerror = () => img.remove();
        chip.appendChild(img);
      }
      const name = document.createElement('span');
      name.textContent = link.name;
      chip.appendChild(name);
      container.appendChild(chip);
    }
  });
}

// â”€â”€â”€ Colour swatch picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function mkSwatchPicker(selectedColor, colors, getSwatchClass, onSelect) {
  const wrap = document.createElement('div');
  wrap.className = 'flex flex-wrap gap-2 mt-1';
  colors.forEach(color => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.title = color;
    btn.dataset.color = color;
    const swatchClass = getSwatchClass(color);
    const isSelected = color === selectedColor;
    btn.className = `w-7 h-7 rounded-full ${swatchClass} transition-all ${isSelected ? 'ring-2 ring-offset-2 ring-current scale-110' : 'opacity-70 hover:opacity-100 hover:scale-105'}`;
    btn.addEventListener('click', () => {
      wrap.querySelectorAll('button').forEach(b => {
        b.className = `w-7 h-7 rounded-full ${getSwatchClass(b.dataset.color)} transition-all opacity-70 hover:opacity-100 hover:scale-105`;
      });
      btn.className = `w-7 h-7 rounded-full ${swatchClass} transition-all ring-2 ring-offset-2 ring-current scale-110`;
      onSelect(color);
    });
    wrap.appendChild(btn);
  });
  return wrap;
}

// â”€â”€â”€ Modal system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openModal(contentEl, maxWidth = 'max-w-md') {
  const b = FIXED;
  const box = document.getElementById('modalBox');
  box.className = `relative w-full ${maxWidth} rounded-2xl shadow-2xl overflow-hidden ${b.card.split(' ').slice(0, 2).join(' ')}`;
  document.getElementById('modalContent').innerHTML = '';
  document.getElementById('modalContent').appendChild(contentEl);
  document.getElementById('modalOverlay').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.add('hidden');
}

document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (menuOpen) { closeMenu(); return; }
    if (searchOpen) closeSearch(); else closeModal();
    return;
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    if (searchOpen) closeSearch(); else openSearch();
    return;
  }
  if ((e.ctrlKey || e.metaKey) && (e.key === '=' || e.key === '+')) {
    e.preventDefault();
    const idx = ZOOM_LEVELS.indexOf(currentZoom);
    if (idx < ZOOM_LEVELS.length - 1) applyZoom(ZOOM_LEVELS[idx + 1]);
    return;
  }
  if ((e.ctrlKey || e.metaKey) && e.key === '-') {
    e.preventDefault();
    const idx = ZOOM_LEVELS.indexOf(currentZoom);
    if (idx > 0) applyZoom(ZOOM_LEVELS[idx - 1]);
    return;
  }
  if ((e.ctrlKey || e.metaKey) && e.key === '0') {
    e.preventDefault();
    applyZoom(100);
    return;
  }
  if (e.key === '/' && !searchOpen) {
    const tag = document.activeElement ? document.activeElement.tagName : '';
    if (tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT') {
      e.preventDefault();
      openSearch();
      return;
    }
  }
  if (!searchOpen && !document.querySelector('#modalOverlay:not(.hidden)') && !state.editMode) {
    const key = e.key.toLowerCase();
    const allLinks = (state.config?.groups || []).flatMap(g => g.links);
    const match = allLinks.find(l => l.hotkey && l.hotkey === key);
    if (match && !['input','textarea','select'].includes(document.activeElement?.tagName?.toLowerCase())) {
      e.preventDefault();
      window.open(match.url, '_blank', 'noopener');
    }
  }
  if (searchOpen) {
    if (e.key === 'ArrowDown') { e.preventDefault(); moveSearchSelection(1); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); moveSearchSelection(-1); }
    else if (e.key === 'Enter') {
      const items = document.querySelectorAll('#searchResults li[data-search-idx]');
      if (selectedSearchIdx >= 0 && items[selectedSearchIdx]) items[selectedSearchIdx].click();
    }
  }
});

// â”€â”€â”€ Group modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openGroupModal(group) {
  const b = FIXED;
  let selectedAccent = group ? group.accent : 'slate';
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = group ? 'Edit group' : 'Add group';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('Group name', b.sub));
  const nameInput = mkInput(group ? group.name : '', 'e.g. Media, Infrastructure', b);
  wrap.appendChild(nameInput);

  const accLabel = mkLabel('Accent colour', b.sub);
  accLabel.className += ' mt-4 block';
  wrap.appendChild(accLabel);
  wrap.appendChild(mkSwatchPicker(selectedAccent, PALETTES, c => ACCENT[c].swatch, c => { selectedAccent = c; }));

  const iconLabel = mkLabel('Icon slug (optional)', b.sub);
  iconLabel.className += ' mt-4 block';
  wrap.appendChild(iconLabel);

  const iconRow = document.createElement('div');
  iconRow.className = 'flex items-center gap-3';
  const iconInput = mkInput(group ? (group.icon || '') : '', 'e.g. home-assistant, proxmox', b);
  iconInput.className += ' flex-1';
  iconRow.appendChild(iconInput);

  const iconPreview = document.createElement('img');
  iconPreview.className = 'w-8 h-8 object-contain flex-shrink-0';
  iconPreview.style.display = 'none';
  iconPreview.onerror = () => { iconPreview.style.display = 'none'; };
  iconRow.appendChild(iconPreview);

  function updateGrpIconPreview() {
    const slug = iconInput.value.trim().replace(/[^a-z0-9-]/g, '');
    if (slug) { iconPreview.src = `/api/icon/${slug}?t=${Date.now()}`; iconPreview.style.display = 'block'; }
    else { iconPreview.style.display = 'none'; }
  }
  iconInput.addEventListener('input', updateGrpIconPreview);
  if (group && group.icon) updateGrpIconPreview();
  wrap.appendChild(iconRow);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);

  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.textContent = group ? 'Save' : 'Create';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    const name = nameInput.value.trim();
    const icon = iconInput.value.trim().replace(/[^a-z0-9-]/g, '');
    if (!name) { nameInput.focus(); return; }
    if (group) {
      await api('PUT', `/api/groups/${group.id}`, { name, accent: selectedAccent, icon });
    } else {
      await api('POST', '/api/groups', { name, accent: selectedAccent, icon });
    }
    closeModal();
    await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);

  openModal(wrap);
  nameInput.focus();
}

// â”€â”€â”€ Link modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openLinkModal(groupId, link) {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = link ? 'Edit link' : 'Add link';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('Name', b.sub));
  const nameInput = mkInput(link ? link.name : '', 'e.g. Plex', b);
  wrap.appendChild(nameInput);

  const urlLabel = mkLabel('URL', b.sub);
  urlLabel.className += ' mt-3 block';
  wrap.appendChild(urlLabel);
  const urlInput = mkInput(link ? link.url : '', 'http://192.168.1.10:32400', b);
  urlInput.type = 'url';
  wrap.appendChild(urlInput);

  const iconLabel = mkLabel('Icon slug', b.sub);
  iconLabel.className += ' mt-3 block';
  wrap.appendChild(iconLabel);

  const iconRow = document.createElement('div');
  iconRow.className = 'flex items-center gap-3';
  const iconInput = mkInput(link ? link.icon : '', 'e.g. plex, jellyfin, portainer', b);
  iconInput.className += ' flex-1';
  iconRow.appendChild(iconInput);

  const iconPreview = document.createElement('img');
  iconPreview.className = 'w-9 h-9 object-contain flex-shrink-0';
  iconPreview.style.display = 'none';
  iconPreview.alt = 'icon preview';
  iconPreview.onerror = () => { iconPreview.style.display = 'none'; };
  iconRow.appendChild(iconPreview);

  function updateIconPreview() {
    const slug = iconInput.value.trim().replace(/[^a-z0-9-]/g, '');
    if (slug) {
      iconPreview.src = `/api/icon/${slug}?t=${Date.now()}`;
      iconPreview.style.display = 'block';
    } else {
      iconPreview.style.display = 'none';
    }
  }
  iconInput.addEventListener('input', updateIconPreview);
  if (link && link.icon) updateIconPreview();

  wrap.appendChild(iconRow);
  const iconHint = document.createElement('p');
  iconHint.className = `text-xs mt-1 ${b.sub}`;
  iconHint.innerHTML = 'Find slugs at <a href="https://dashboardicons.com/icons" target="_blank" rel="noopener" class="underline">dashboardicons.com/icons</a>';
  wrap.appendChild(iconHint);

  // Icon background (squircle colour)
  let selectedIconBg = link ? (link.iconBg || 'none') : 'none';
  const bgLabel = mkLabel('Icon background', b.sub);
  bgLabel.className += ' mt-3 block';
  wrap.appendChild(bgLabel);

  const bgPicker = document.createElement('div');
  bgPicker.className = 'flex flex-wrap gap-2 mt-1 items-center';

  ICON_BG_OPTIONS.forEach(opt => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.title = opt.label;
    btn.dataset.key = opt.key;
    btn.className = 'w-7 h-7 rounded-full border-2 transition-all flex-shrink-0';

    if (opt.hex) {
      btn.style.backgroundColor = opt.hex;
      btn.style.borderColor = opt.key === 'white' || opt.key === 'light' ? '#d1d5db' : opt.hex;
    } else {
      // "None" â€” diagonal line through white circle
      btn.style.background = 'linear-gradient(to bottom right,#fff calc(50% - 1px),#ef4444 calc(50% - 1px),#ef4444 calc(50% + 1px),#fff calc(50% + 1px))';
      btn.style.borderColor = '#d1d5db';
    }

    const isSelected = opt.key === selectedIconBg;
    btn.style.outline = isSelected ? '2px solid #6366f1' : 'none';
    btn.style.outlineOffset = '2px';
    btn.style.opacity = isSelected ? '1' : '0.7';
    btn.style.transform = isSelected ? 'scale(1.15)' : 'scale(1)';

    btn.addEventListener('click', () => {
      selectedIconBg = opt.key;
      bgPicker.querySelectorAll('button').forEach(b2 => {
        b2.style.outline = 'none';
        b2.style.opacity = '0.7';
        b2.style.transform = 'scale(1)';
      });
      btn.style.outline = '2px solid #6366f1';
      btn.style.outlineOffset = '2px';
      btn.style.opacity = '1';
      btn.style.transform = 'scale(1.15)';
    });

    bgPicker.appendChild(btn);
  });
  wrap.appendChild(bgPicker);

  const descLabel = mkLabel('Description (optional)', b.sub);
  descLabel.className += ' mt-3 block';
  wrap.appendChild(descLabel);
  const descInput = mkInput(link ? link.description : '', 'Short noteâ€¦', b);
  wrap.appendChild(descInput);

  // Ping toggle + custom ping URL
  const pingRow = document.createElement('div');
  pingRow.className = 'flex items-center gap-2 mt-4';
  const pingCheck = document.createElement('input');
  pingCheck.type = 'checkbox';
  pingCheck.id = 'linkPingCheck';
  pingCheck.checked = link ? link.ping !== false : true;
  pingCheck.className = 'rounded';
  const pingLabelEl = document.createElement('label');
  pingLabelEl.htmlFor = 'linkPingCheck';
  pingLabelEl.className = `text-sm cursor-pointer ${b.text}`;
  pingLabelEl.textContent = 'Check service status';
  pingRow.appendChild(pingCheck);
  pingRow.appendChild(pingLabelEl);
  wrap.appendChild(pingRow);

  const pingUrlSection = document.createElement('div');
  pingUrlSection.className = pingCheck.checked ? 'mt-2' : 'mt-2 hidden';
  const pingUrlLabel = mkLabel('Custom ping URL (optional)', b.sub);
  pingUrlSection.appendChild(pingUrlLabel);
  const pingUrlInput = mkInput(link ? (link.pingUrl || '') : '', 'Defaults to link URL', b);
  pingUrlSection.appendChild(pingUrlInput);
  wrap.appendChild(pingUrlSection);

  pingCheck.addEventListener('change', () => {
    pingUrlSection.classList.toggle('hidden', !pingCheck.checked);
  });

  // Pinned
  const pinnedRow = document.createElement('div');
  pinnedRow.className = 'flex items-center gap-2 mt-3';
  const pinnedCheck = document.createElement('input');
  pinnedCheck.type = 'checkbox';
  pinnedCheck.id = 'linkPinnedCheck';
  pinnedCheck.checked = link ? Boolean(link.pinned) : false;
  pinnedCheck.className = 'rounded';
  const pinnedLabelEl = document.createElement('label');
  pinnedLabelEl.htmlFor = 'linkPinnedCheck';
  pinnedLabelEl.className = `text-sm cursor-pointer ${b.text}`;
  pinnedLabelEl.textContent = 'Pin to top of page';
  pinnedRow.appendChild(pinnedCheck);
  pinnedRow.appendChild(pinnedLabelEl);
  wrap.appendChild(pinnedRow);

  // Hotkey
  const hotkeyLabel = mkLabel('Hotkey (optional)', b.sub);
  hotkeyLabel.className += ' mt-3 block';
  wrap.appendChild(hotkeyLabel);
  const hotkeyInput = mkInput(link ? (link.hotkey || '') : '', 'e.g. p', b);
  hotkeyInput.maxLength = 1;
  hotkeyInput.pattern = '[a-z0-9]';
  hotkeyInput.style.width = '4rem';
  hotkeyInput.addEventListener('input', () => {
    hotkeyInput.value = hotkeyInput.value.toLowerCase().replace(/[^a-z0-9]/g, '');
  });
  wrap.appendChild(hotkeyInput);
  const hotkeyHint = document.createElement('p');
  hotkeyHint.className = `text-xs mt-1 mb-1 ${b.sub}`;
  hotkeyHint.textContent = 'Single letter/digit. Press that key on the dashboard to open the link.';
  wrap.appendChild(hotkeyHint);

  const tagsLabel = mkLabel('Tags', b.sub);
  tagsLabel.className += ' mt-3 block';
  wrap.appendChild(tagsLabel);
  const tagsInput = mkInput((link?.tags || []).join(', '), 'media, home, work', b);
  wrap.appendChild(tagsInput);
  const tagsHint = document.createElement('p');
  tagsHint.className = `text-xs mt-1 mb-1 ${b.sub}`;
  tagsHint.textContent = 'Comma-separated. Used to filter links on the dashboard.';
  wrap.appendChild(tagsHint);

  // Group picker â€” lets user move an existing link to a different group
  let targetGroupId = groupId;
  if (state.config.groups.length > 1) {
    const groupLabel = mkLabel('Group', b.sub);
    groupLabel.className += ' mt-3 block';
    wrap.appendChild(groupLabel);

    const groupSelect = document.createElement('select');
    groupSelect.className = `w-full px-3 py-2 rounded-lg text-sm border ${b.card} ${b.text} focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all`;
    state.config.groups.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = g.name;
      opt.selected = g.id === groupId;
      groupSelect.appendChild(opt);
    });
    groupSelect.addEventListener('change', () => { targetGroupId = groupSelect.value; });
    wrap.appendChild(groupSelect);
  }

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);

  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.textContent = link ? 'Save' : 'Add';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    const name = nameInput.value.trim();
    const url = urlInput.value.trim();
    if (!name) { nameInput.focus(); return; }
    if (!url) { urlInput.focus(); return; }
    const payload = {
      name, url,
      icon: iconInput.value.trim().replace(/[^a-z0-9-]/g, ''),
      iconBg: selectedIconBg,
      description: descInput.value.trim(),
      ping:    pingCheck.checked,
      pingUrl: pingCheck.checked ? pingUrlInput.value.trim() : '',
      pinned:  pinnedCheck.checked,
      hotkey: hotkeyInput.value.trim().slice(0,1).toLowerCase().replace(/[^a-z0-9]/g,''),
      tags:   tagsInput.value.split(',').map(t => t.trim().toLowerCase()).filter(Boolean).slice(0, 10),
    };
    if (link) {
      if (targetGroupId !== groupId) {
        // Move to new group first, then update fields
        await api('POST', '/api/links/move', {
          linkId: link.id,
          sourceGroupId: groupId,
          targetGroupId,
        });
        await api('PUT', `/api/groups/${targetGroupId}/links/${link.id}`, payload);
      } else {
        await api('PUT', `/api/groups/${groupId}/links/${link.id}`, payload);
      }
    } else {
      await api('POST', `/api/groups/${groupId}/links`, payload);
    }
    closeModal();
    await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);

  openModal(wrap);
  nameInput.focus();
}

// â”€â”€â”€ Settings modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openSettingsModal() {
  const cfg = state.config;
  const b = FIXED;
  let selectedBase = cfg.basePalette;
  let selectedPingInterval = cfg.pingInterval ?? 60;
  let bgType  = (cfg.background && cfg.background.type)  || 'none';
  let bgValue = (cfg.background && cfg.background.value) || '';

  const wrap = document.createElement('div');

  // â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const titleEl = document.createElement('h2');
  titleEl.className = `text-base font-semibold mb-3 ${b.text}`;
  titleEl.textContent = 'Settings';
  wrap.appendChild(titleEl);

  // â”€â”€ Tab strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const TABS = ['General', 'Background', 'Appearance', 'Data'];
  const panels = {};
  const tabStrip = document.createElement('div');
  tabStrip.className = 'flex border-b border-stone-200 dark:border-stone-700 mb-5 -mx-6 px-6';

  const switchTab = name => {
    tabStrip.querySelectorAll('[data-tab]').forEach(btn => {
      const on = btn.dataset.tab === name;
      btn.className = `px-3 py-2 text-sm font-medium border-b-2 -mb-px transition-colors whitespace-nowrap ${
        on ? `border-indigo-500 ${b.text}` : `border-transparent ${b.sub} hover:border-stone-400`
      }`;
    });
    Object.entries(panels).forEach(([n, p]) => p.classList.toggle('hidden', n !== name));
  };

  TABS.forEach(name => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = name;
    btn.dataset.tab = name;
    btn.addEventListener('click', () => switchTab(name));
    tabStrip.appendChild(btn);
  });
  wrap.appendChild(tabStrip);

  // â”€â”€ GENERAL panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const genPanel = document.createElement('div');

  genPanel.appendChild(mkLabel('Dashboard title', b.sub));
  const titleInput = mkInput(cfg.title || '', 'My Dashboard', b);
  genPanel.appendChild(titleInput);

  const bpLabel = mkLabel('Colour palette', b.sub);
  bpLabel.className += ' mt-4 block';
  genPanel.appendChild(bpLabel);
  const bpHint = document.createElement('p');
  bpHint.className = `text-xs mb-2 ${b.sub}`;
  bpHint.textContent = 'Colours the top bar. Cards are always stone.';
  genPanel.appendChild(bpHint);
  genPanel.appendChild(mkSwatchPicker(selectedBase, PALETTES, c => ACCENT[c].swatch, c => { selectedBase = c; }));

  const piLabel = mkLabel('Ping interval', b.sub);
  piLabel.className += ' mt-4 block';
  genPanel.appendChild(piLabel);
  const piRow = document.createElement('div');
  piRow.className = 'flex gap-2 mt-1';
  const piBase   = 'px-3 py-1.5 rounded-lg text-sm border transition-colors';
  const piActive = 'bg-indigo-600 text-white border-indigo-600';
  const piIdle   = `border-stone-300 dark:border-stone-600 ${b.text} hover:bg-stone-100 dark:hover:bg-stone-700`;
  [{ value: 30, label: '30s' }, { value: 60, label: '1m' }, { value: 300, label: '5m' }, { value: 0, label: 'Off' }].forEach(opt => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = opt.label;
    btn.dataset.piVal = opt.value;
    btn.className = `${piBase} ${opt.value === selectedPingInterval ? piActive : piIdle}`;
    btn.addEventListener('click', () => {
      selectedPingInterval = opt.value;
      piRow.querySelectorAll('button').forEach(b2 => {
        b2.className = `${piBase} ${Number(b2.dataset.piVal) === selectedPingInterval ? piActive : piIdle}`;
      });
    });
    piRow.appendChild(btn);
  });
  genPanel.appendChild(piRow);
  panels['General'] = genPanel;

  // â”€â”€ BACKGROUND panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const bgPanel = document.createElement('div');

  const bgTypeRow = document.createElement('div');
  bgTypeRow.className = 'flex gap-2 mb-3';
  const bgTypePillBase   = 'px-3 py-1.5 rounded-lg text-sm border transition-colors';
  const bgTypePillActive = 'bg-indigo-600 text-white border-indigo-600';
  const bgTypePillIdle   = `border-stone-300 dark:border-stone-600 ${b.text} hover:bg-stone-100 dark:hover:bg-stone-700`;

  const bgGradientSection = document.createElement('div');
  bgGradientSection.className = bgType === 'gradient' ? 'mb-2' : 'hidden mb-2';
  const gradParts = bgValue.includes(',') ? bgValue.split(',') : ['#0f172a', '#1e293b'];
  let gradC1 = gradParts[0] || '#0f172a';
  let gradC2 = gradParts[1] || '#1e293b';

  const presetRow = document.createElement('div');
  presetRow.className = 'flex gap-2 flex-wrap mb-3';
  let c1Input, c2Input;
  [{ label: 'Midnight', value: '#0f172a,#1e293b' }, { label: 'Forest', value: '#052e16,#14532d' }, { label: 'Ember', value: '#1c0a00,#431407' }, { label: 'Space', value: '#09090b,#18181b' }].forEach(preset => {
    const [p1, p2] = preset.value.split(',');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = preset.label;
    btn.className = 'px-2.5 py-1 text-xs rounded-lg text-white font-medium border-0 transition-opacity hover:opacity-90';
    btn.style.background = `linear-gradient(135deg,${p1},${p2})`;
    btn.addEventListener('click', () => { gradC1 = p1; gradC2 = p2; bgValue = preset.value; if (c1Input) c1Input.value = gradC1; if (c2Input) c2Input.value = gradC2; });
    presetRow.appendChild(btn);
  });
  bgGradientSection.appendChild(presetRow);

  const colorPickerRow = document.createElement('div');
  colorPickerRow.className = 'flex items-center gap-3';
  const c1Label = document.createElement('label'); c1Label.className = `text-xs ${b.sub}`; c1Label.textContent = 'Color 1';
  c1Input = document.createElement('input'); c1Input.type = 'color'; c1Input.value = gradC1;
  c1Input.className = 'w-8 h-8 rounded cursor-pointer border border-stone-300 dark:border-stone-600';
  c1Input.addEventListener('input', () => { gradC1 = c1Input.value; bgValue = `${gradC1},${gradC2}`; });
  const c2Label = document.createElement('label'); c2Label.className = `text-xs ${b.sub}`; c2Label.textContent = 'Color 2';
  c2Input = document.createElement('input'); c2Input.type = 'color'; c2Input.value = gradC2;
  c2Input.className = 'w-8 h-8 rounded cursor-pointer border border-stone-300 dark:border-stone-600';
  c2Input.addEventListener('input', () => { gradC2 = c2Input.value; bgValue = `${gradC1},${gradC2}`; });
  colorPickerRow.appendChild(c1Label); colorPickerRow.appendChild(c1Input);
  colorPickerRow.appendChild(c2Label); colorPickerRow.appendChild(c2Input);
  bgGradientSection.appendChild(colorPickerRow);

  const bgImageSection = document.createElement('div');
  bgImageSection.className = bgType === 'image' ? 'mb-2' : 'hidden mb-2';
  const bgImageInput = mkInput(bgType === 'image' ? bgValue : '', 'https://example.com/background.jpg', b);
  bgImageInput.addEventListener('input', () => { bgValue = bgImageInput.value.trim(); });
  bgImageSection.appendChild(bgImageInput);

  [{ value: 'none', label: 'None' }, { value: 'gradient', label: 'Gradient' }, { value: 'image', label: 'Image URL' }].forEach(opt => {
    const btn = document.createElement('button');
    btn.type = 'button'; btn.textContent = opt.label; btn.dataset.bgType = opt.value;
    btn.className = `${bgTypePillBase} ${opt.value === bgType ? bgTypePillActive : bgTypePillIdle}`;
    btn.addEventListener('click', () => {
      bgType = opt.value;
      bgTypeRow.querySelectorAll('button').forEach(b2 => { b2.className = `${bgTypePillBase} ${b2.dataset.bgType === bgType ? bgTypePillActive : bgTypePillIdle}`; });
      bgGradientSection.className = bgType === 'gradient' ? 'mb-2' : 'hidden mb-2';
      bgImageSection.className    = bgType === 'image'    ? 'mb-2' : 'hidden mb-2';
      if (bgType === 'gradient') bgValue = `${gradC1},${gradC2}`;
      else if (bgType === 'image') bgValue = bgImageInput.value.trim();
      else bgValue = '';
    });
    bgTypeRow.appendChild(btn);
  });
  bgPanel.appendChild(bgTypeRow);
  bgPanel.appendChild(bgGradientSection);
  bgPanel.appendChild(bgImageSection);
  panels['Background'] = bgPanel;

  // â”€â”€ APPEARANCE panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const appPanel = document.createElement('div');

  const sharpRow = document.createElement('label');
  sharpRow.className = 'flex items-center justify-between cursor-pointer mb-5';
  const sharpLabel = document.createElement('div');
  const sharpTitle = document.createElement('span'); sharpTitle.className = `text-sm font-medium ${b.text}`; sharpTitle.textContent = 'Sharp corners';
  const sharpDesc = document.createElement('p'); sharpDesc.className = `text-xs ${b.sub}`; sharpDesc.textContent = 'Removes all border-radius from the UI';
  sharpLabel.appendChild(sharpTitle); sharpLabel.appendChild(sharpDesc);
  const sharpToggle = document.createElement('input'); sharpToggle.type = 'checkbox'; sharpToggle.checked = !!cfg.sharpCorners;
  sharpToggle.className = 'w-4 h-4 accent-indigo-600 flex-shrink-0';
  sharpRow.appendChild(sharpLabel); sharpRow.appendChild(sharpToggle);
  appPanel.appendChild(sharpRow);

  const cssLabel = mkLabel('Custom CSS', b.sub);
  appPanel.appendChild(cssLabel);
  const cssHint = document.createElement('p'); cssHint.className = `text-xs mb-2 ${b.sub}`; cssHint.textContent = 'Injected into <style> on every page load.';
  appPanel.appendChild(cssHint);
  const cssArea = document.createElement('textarea');
  cssArea.value = cfg.customCss || '';
  cssArea.placeholder = '/* e.g. body { font-family: monospace; } */';
  cssArea.rows = 7; cssArea.autocomplete = 'off';
  cssArea.className = `w-full px-3 py-2 rounded-lg text-xs border font-mono ${b.card} ${b.text} focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all resize-y`;
  appPanel.appendChild(cssArea);
  panels['Appearance'] = appPanel;

  // â”€â”€ DATA panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dataPanel = document.createElement('div');

  const favTitle = document.createElement('p');
  favTitle.className = `text-xs font-semibold uppercase tracking-wider mb-3 ${b.sub}`;
  favTitle.textContent = 'Favicon';
  dataPanel.appendChild(favTitle);

  const favRow = document.createElement('div');
  favRow.className = 'flex items-center gap-3 mb-6';
  const favPreview = document.createElement('img');
  favPreview.src = '/api/favicon?t=' + Date.now();
  favPreview.className = 'w-10 h-10 object-contain rounded border border-stone-200 dark:border-stone-700 flex-shrink-0';
  favPreview.onerror = () => { favPreview.style.opacity = '0'; };
  favRow.appendChild(favPreview);
  const favFileInput = document.createElement('input'); favFileInput.type = 'file'; favFileInput.accept = 'image/*'; favFileInput.className = 'hidden';
  favFileInput.addEventListener('change', async () => {
    const file = favFileInput.files && favFileInput.files[0]; if (!file) return;
    try {
      const res = await fetch('/api/favicon', { method: 'POST', headers: { 'Content-Type': file.type }, body: file });
      if (!res.ok) throw new Error(`Server returned ${res.status}`);
      favPreview.style.opacity = '1'; favPreview.src = '/api/favicon?t=' + Date.now(); refreshFavicon(); showToast('Favicon updated');
    } catch (err) { showToast('Upload failed â€” ' + err.message, 'error'); }
    favFileInput.value = '';
  });
  favRow.appendChild(favFileInput);
  const uploadFavBtn = document.createElement('button'); uploadFavBtn.type = 'button'; uploadFavBtn.textContent = 'â†‘ Upload';
  uploadFavBtn.className = 'px-3 py-2 rounded-lg text-sm font-medium border border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors';
  uploadFavBtn.addEventListener('click', () => favFileInput.click());
  favRow.appendChild(uploadFavBtn);
  const removeFavBtn = document.createElement('button'); removeFavBtn.type = 'button'; removeFavBtn.textContent = 'âœ• Remove';
  removeFavBtn.className = 'px-3 py-2 rounded-lg text-sm font-medium border border-red-200 dark:border-red-800/60 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors';
  removeFavBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/favicon', { method: 'DELETE' }); if (!res.ok) throw new Error(`Server returned ${res.status}`);
      favPreview.style.opacity = '0'; refreshFavicon(); showToast('Favicon removed');
    } catch (err) { showToast('Remove failed â€” ' + err.message, 'error'); }
  });
  favRow.appendChild(removeFavBtn);
  dataPanel.appendChild(favRow);

  const ioTitle = document.createElement('p');
  ioTitle.className = `text-xs font-semibold uppercase tracking-wider mb-3 ${b.sub}`;
  ioTitle.textContent = 'Import / Export';
  dataPanel.appendChild(ioTitle);
  const ioRow = document.createElement('div'); ioRow.className = 'flex gap-3';
  const exportBtn = document.createElement('button'); exportBtn.type = 'button'; exportBtn.textContent = 'â†“ Export JSON';
  exportBtn.className = 'flex-1 px-3 py-2 rounded-lg text-sm font-medium border border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors';
  exportBtn.addEventListener('click', exportConfig);
  ioRow.appendChild(exportBtn);
  const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json,application/json'; fileInput.className = 'hidden';
  fileInput.addEventListener('change', () => { if (fileInput.files && fileInput.files[0]) importConfig(fileInput.files[0]); });
  ioRow.appendChild(fileInput);
  const importBtn = document.createElement('button'); importBtn.type = 'button'; importBtn.textContent = 'â†‘ Import JSON';
  importBtn.className = 'flex-1 px-3 py-2 rounded-lg text-sm font-medium border border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors';
  importBtn.addEventListener('click', () => fileInput.click());
  ioRow.appendChild(importBtn);
  dataPanel.appendChild(ioRow);
  const ioNote = document.createElement('p'); ioNote.className = `text-xs mt-2 ${b.sub}`; ioNote.textContent = 'Import replaces all groups and links.';
  dataPanel.appendChild(ioNote);
  panels['Data'] = dataPanel;

  // Append panels and activate first tab
  Object.values(panels).forEach(p => wrap.appendChild(p));
  switchTab('General');

  // â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6 pt-4 border-t border-stone-200 dark:border-stone-700';
  const cancelBtn = document.createElement('button'); cancelBtn.type = 'button'; cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);
  const saveBtn = document.createElement('button'); saveBtn.type = 'button'; saveBtn.textContent = 'Save';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    await api('PUT', '/api/config', {
      title: titleInput.value.trim() || 'My Dashboard',
      basePalette: selectedBase,
      pingInterval: selectedPingInterval,
      background: { type: bgType, value: bgValue },
      sharpCorners: sharpToggle.checked,
      customCss: cssArea.value,
    });
    closeModal();
    await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);

  openModal(wrap, 'max-w-lg');
  titleInput.focus();
}

// â”€â”€â”€ Search overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openSearch() {
  searchOpen = true;
  selectedSearchIdx = -1;
  document.getElementById('searchOverlay').classList.remove('hidden');
  const input = document.getElementById('searchInput');
  input.value = '';
  renderSearchResults('');
  requestAnimationFrame(() => input.focus());
}

function closeSearch() {
  searchOpen = false;
  document.getElementById('searchOverlay').classList.add('hidden');
}

function closeMenu() {
  menuOpen = false;
  document.getElementById('menuDropdown').classList.add('hidden');
}

function renderSearchResults(query) {
  const list  = document.getElementById('searchResults');
  const count = document.getElementById('searchCount');
  list.innerHTML = '';
  selectedSearchIdx = -1;

  const allLinks = (state.config?.groups || []).flatMap(g =>
    g.links.map(l => ({ link: l, groupName: g.name, groupAccent: g.accent }))
  );

  const q = query.toLowerCase().trim();
  const matches = q
    ? allLinks.filter(({ link: l }) =>
        l.name.toLowerCase().includes(q) ||
        (l.description || '').toLowerCase().includes(q) ||
        l.url.toLowerCase().includes(q)
      )
    : allLinks.slice(0, 8);

  if (count) count.textContent = matches.length ? `${matches.length} result${matches.length === 1 ? '' : 's'}` : '';

  if (matches.length === 0) {
    const empty = document.createElement('li');
    empty.className = 'px-4 py-8 text-sm text-center text-stone-400 dark:text-stone-500';
    empty.textContent = query ? 'No links match your search.' : 'No links yet â€” add some in edit mode.';
    list.appendChild(empty);
    return;
  }

  matches.forEach(({ link, groupName, groupAccent }, idx) => {
    const li = document.createElement('li');
    li.role = 'option';
    li.dataset.searchIdx = String(idx);
    li.dataset.url = link.url;
    // border-l-2 always present; color changes on selection
    li.className = 'flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors border-l-2 border-transparent hover:bg-stone-50 dark:hover:bg-stone-800/60';

    const wrap = mkIconWrap(link);
    const dot = wrap.querySelector('[data-status-id]');
    if (dot) {
      const s = statusMap[link.id];
      dot.className = 'absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full ring-2 ring-white dark:ring-stone-900';
      if      (s === 'up')   dot.className += ' bg-green-400';
      else if (s === 'down') dot.className += ' bg-red-500';
      else                   dot.className += ' bg-stone-300 dark:bg-stone-600';
    }
    li.appendChild(wrap);

    const textDiv = document.createElement('div');
    textDiv.className = 'flex-1 min-w-0';

    const nameEl = document.createElement('div');
    nameEl.className = 'text-sm font-semibold truncate text-stone-800 dark:text-stone-100';
    nameEl.textContent = link.name;
    textDiv.appendChild(nameEl);

    const subText = link.description || link.url;
    const subEl = document.createElement('div');
    subEl.className = 'text-xs truncate text-stone-400 dark:text-stone-500 mt-0.5';
    subEl.textContent = subText;
    textDiv.appendChild(subEl);

    li.appendChild(textDiv);

    // Group badge
    const badge = document.createElement('span');
    badge.className = 'flex-shrink-0 text-xs px-2 py-0.5 rounded-full font-medium bg-stone-100 dark:bg-stone-700/60 text-stone-500 dark:text-stone-400';
    badge.textContent = groupName;
    li.appendChild(badge);

    li.addEventListener('click', () => {
      window.open(link.url, '_blank', 'noopener');
      closeSearch();
    });

    list.appendChild(li);
  });
}

function moveSearchSelection(delta) {
  const items = Array.from(document.querySelectorAll('#searchResults li[data-search-idx]'));
  if (!items.length) return;
  // Deselect old
  if (selectedSearchIdx >= 0 && selectedSearchIdx < items.length) {
    items[selectedSearchIdx].classList.remove('bg-indigo-50', 'dark:bg-indigo-950/40', 'border-indigo-400');
    items[selectedSearchIdx].classList.add('border-transparent');
  }
  selectedSearchIdx = Math.max(0, Math.min(items.length - 1, selectedSearchIdx + delta));
  items[selectedSearchIdx].classList.add('bg-indigo-50', 'dark:bg-indigo-950/40', 'border-indigo-400');
  items[selectedSearchIdx].classList.remove('border-transparent');
  items[selectedSearchIdx].scrollIntoView({ block: 'nearest' });
}

// â”€â”€â”€ Toast notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showToast(message, type = 'success') {
  const t = document.createElement('div');
  t.className = `fixed bottom-6 left-1/2 -translate-x-1/2 z-[70] px-4 py-2.5 rounded-lg shadow-lg text-sm font-medium pointer-events-none transition-opacity duration-300 ${
    type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
  }`;
  t.textContent = message;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
}

// â”€â”€â”€ Favicon helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function refreshFavicon() {
  const link = document.getElementById('faviconLink');
  if (link) link.href = '/api/favicon?t=' + Date.now();
}

// â”€â”€â”€ Config import / export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function exportConfig() {
  try {
    const res  = await fetch('/api/config/export');
    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = 'tailboard-config.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
  } catch (err) {
    alert('Export failed: ' + err.message);
  }
}

async function importConfig(file) {
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    await api('POST', '/api/config/import', data);
    closeModal();
    await reload();
  } catch (err) {
    alert('Import failed â€” make sure the file is a valid tailboard config JSON.\n\n' + err.message);
  }
}

// â”€â”€â”€ Form helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function mkLabel(text, subClass) {
  const el = document.createElement('label');
  el.className = `block text-xs font-semibold uppercase tracking-wider mb-1 ${subClass}`;
  el.textContent = text;
  return el;
}

function mkInput(value, placeholder, b) {
  const el = document.createElement('input');
  el.type = 'text';
  el.value = value || '';
  el.placeholder = placeholder || '';
  el.autocomplete = 'off';
  el.className = `w-full px-3 py-2 rounded-lg text-sm border ${b.card} ${b.text} focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all`;
  return el;
}

// â”€â”€â”€ Background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function applyBackground(bg) {
  document.body.style.backgroundImage = '';
  document.body.style.background = '';
  if (!bg || bg.type === 'none') return;
  if (bg.type === 'gradient') {
    const parts = (bg.value || '#1e293b,#0f172a').split(',');
    const c1 = parts[0] || '#1e293b';
    const c2 = parts[1] || '#0f172a';
    document.body.style.background = `linear-gradient(135deg,${c1},${c2})`;
  } else if (bg.type === 'image' && bg.value) {
    Object.assign(document.body.style, {
      backgroundImage: `url(${bg.value})`,
      backgroundSize: 'cover',
      backgroundPosition: 'center',
      backgroundAttachment: 'fixed',
    });
  }
}

// â”€â”€â”€ Add-widget button helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function mkAddWidgetBtn(label, onClick) {
  const btn = document.createElement('button');
  btn.className = `rounded-xl border-2 border-dashed border-stone-300 dark:border-stone-600 p-4 text-sm font-medium ${FIXED.sub} hover:bg-black/5 dark:hover:bg-white/5 transition-colors w-full`;
  btn.textContent = label;
  btn.onclick = onClick;
  return btn;
}

function openAddWidgetModal() {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-5 ${b.text}`;
  title.textContent = 'Add widget';
  wrap.appendChild(title);

  const svgFolder    = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v8.25A2.25 2.25 0 0 0 4.5 16.5h15a2.25 2.25 0 0 0 2.25-2.25V9A2.25 2.25 0 0 0 19.5 6.75h-5.379a1.5 1.5 0 0 1-1.06-.44Z"/></svg>`;
  const svgDoc       = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"/></svg>`;
  const svgRss       = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 0 0-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/></svg>`;
  const svgCode      = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5"/></svg>`;
  const svgClock     = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>`;
  const svgCalendar  = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>`;

  const choices = [
    { icon: svgFolder,   label: 'Group',     desc: 'A group of links',      fn: openGroupModal     },
    { icon: svgDoc,      label: 'Note',      desc: 'Markdown text card',    fn: openNoteModal      },
    { icon: svgRss,      label: 'RSS Feed',  desc: 'Live feed from a URL',  fn: openFeedModal      },
    { icon: svgCode,     label: 'Embed',     desc: 'iFrame for any URL',    fn: openIframeModal    },
    { icon: svgClock,    label: 'Countdown', desc: 'Date countdown timer',  fn: openCountdownModal },
    { icon: svgCalendar, label: 'Calendar',  desc: 'iCal upcoming events',  fn: openCalendarModal  },
  ];

  const grid = document.createElement('div');
  grid.className = 'grid grid-cols-3 gap-3';

  choices.forEach(({ icon, label, desc, fn }) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = `flex flex-col items-start gap-1 p-4 rounded-xl border-2 border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700 hover:border-indigo-500 dark:hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all text-left`;
    btn.title = desc;
    btn.innerHTML = `<span class="mb-1 opacity-70">${icon}</span><span class="font-semibold text-sm ${b.text}">${label}</span><span class="text-xs ${b.sub}">${desc}</span>`;
    btn.onclick = () => { closeModal(); fn(); };
    grid.appendChild(btn);
  });

  wrap.appendChild(grid);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end mt-5';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);
  wrap.appendChild(footer);

  openModal(wrap);
}

// â”€â”€â”€ Markdown helpers (no deps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function mdInline(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code class="font-mono text-xs bg-black/10 dark:bg-white/10 px-1 rounded">$1</code>');
}

function renderMd(text) {
  const lines = (text || '').split('\n');
  let out = '', inUl = false;
  for (const line of lines) {
    if (/^[-*] /.test(line)) {
      if (!inUl) { out += '<ul class="list-disc list-inside space-y-0.5">'; inUl = true; }
      out += `<li>${mdInline(line.slice(2))}</li>`;
    } else {
      if (inUl) { out += '</ul>'; inUl = false; }
      out += line ? `<p>${mdInline(line)}</p>` : '<br>';
    }
  }
  if (inUl) out += '</ul>';
  return out;
}

// â”€â”€â”€ Note card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderNoteCard(note) {
  const cfg = state.config;
  const t   = TOPBAR[cfg.basePalette] || TOPBAR.stone;
  const b   = FIXED;
  const card = document.createElement('div');
  card.className = `group-section rounded-xl overflow-hidden border shadow-md ${b.card}`;

  // Header
  const hdr = document.createElement('div');
  hdr.className = `flex items-center justify-between px-4 py-2.5 ${t.bar} ${t.text}`;
  const hTitle = document.createElement('span');
  hTitle.className = 'font-semibold text-sm tracking-wide truncate flex-1';
  hTitle.textContent = note.title || 'Notes';
  hdr.appendChild(hTitle);

  if (state.editMode) {
    const editBtn = mkBtn('âœ', 'Edit note', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => openNoteModal(note));
    const delBtn = mkBtn('âœ•', 'Delete note', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', async () => {
      if (!confirm(`Delete note "${note.title}"?`)) return;
      await api('DELETE', `/api/notes/${note.id}`);
      await reload();
    });
    hdr.appendChild(editBtn);
    hdr.appendChild(delBtn);
    const handle = mkHandle('text-white/60 hover:text-white/90 text-base');
    handle.draggable = true;
    handle.addEventListener('dragstart', e => {
      e.stopPropagation();
      dnd = { type: 'widget', id: note.id };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', note.id);
      setTimeout(() => { card.style.opacity = '0.4'; }, 0);
    });
    handle.addEventListener('dragend', () => {
      card.style.opacity = '';
      clearWidgetIndicators();
      dnd = { type: null };
    });
    hdr.insertBefore(handle, hTitle);
  }
  card.appendChild(hdr);

  // Body
  const body = document.createElement('div');
  body.className = `px-4 py-3 text-sm ${b.text} max-h-48 overflow-y-auto`;
  body.innerHTML = renderMd(note.content || '');
  card.appendChild(body);
  return card;
}

// â”€â”€â”€ Feed card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderFeedCard(feed) {
  const cfg = state.config;
  const t   = TOPBAR[cfg.basePalette] || TOPBAR.stone;
  const b   = FIXED;
  const card = document.createElement('div');
  card.className = `group-section rounded-xl overflow-hidden border shadow-md ${b.card}`;

  // Header
  const hdr = document.createElement('div');
  hdr.className = `flex items-center justify-between px-4 py-2.5 ${t.bar} ${t.text}`;
  const hTitle = document.createElement('span');
  hTitle.className = 'font-semibold text-sm tracking-wide truncate flex-1';
  hTitle.textContent = feed.title || 'Feed';
  hdr.appendChild(hTitle);

  const refreshBtn = mkBtn('â†»', 'Refresh feed', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => fetchRss(feed));
  hdr.appendChild(refreshBtn);

  if (state.editMode) {
    const editBtn = mkBtn('âœ', 'Edit feed', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => openFeedModal(feed));
    const delBtn = mkBtn('âœ•', 'Delete feed', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', async () => {
      if (!confirm(`Delete feed "${feed.title}"?`)) return;
      await api('DELETE', `/api/feeds/${feed.id}`);
      await reload();
    });
    hdr.appendChild(editBtn);
    hdr.appendChild(delBtn);
    const handle = mkHandle('text-white/60 hover:text-white/90 text-base');
    handle.draggable = true;
    handle.addEventListener('dragstart', e => {
      e.stopPropagation();
      dnd = { type: 'widget', id: feed.id };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', feed.id);
      setTimeout(() => { card.style.opacity = '0.4'; }, 0);
    });
    handle.addEventListener('dragend', () => {
      card.style.opacity = '';
      clearWidgetIndicators();
      dnd = { type: null };
    });
    hdr.insertBefore(handle, hTitle);
  }
  card.appendChild(hdr);

  // Body placeholder
  const body = document.createElement('div');
  body.id = `rss-${feed.id}`;
  body.className = `px-4 py-3 text-xs ${FIXED.sub}`;
  body.appendChild(mkCardSpinner());
  card.appendChild(body);
  return card;
}

// â”€â”€â”€ iFrame card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderIframeCard(iframe) {
  const cfg = state.config;
  const t   = TOPBAR[cfg.basePalette] || TOPBAR.stone;
  const b   = FIXED;
  const card = document.createElement('div');
  card.className = `group-section rounded-xl overflow-hidden border shadow-md ${b.card}`;

  // Header
  const hdr = document.createElement('div');
  hdr.className = `flex items-center justify-between px-4 py-2.5 ${t.bar} ${t.text}`;
  const hTitle = document.createElement('span');
  hTitle.className = 'font-semibold text-sm tracking-wide truncate flex-1';
  hTitle.textContent = iframe.title || 'Embed';
  hdr.appendChild(hTitle);

  if (state.editMode) {
    const editBtn = mkBtn('âœ', 'Edit embed', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => openIframeModal(iframe));
    const delBtn = mkBtn('âœ•', 'Delete embed', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', async () => {
      if (!confirm(`Delete embed "${iframe.title}"?`)) return;
      await api('DELETE', `/api/iframes/${iframe.id}`);
      await reload();
    });
    hdr.appendChild(editBtn);
    hdr.appendChild(delBtn);
    const handle = mkHandle('text-white/60 hover:text-white/90 text-base');
    handle.draggable = true;
    handle.addEventListener('dragstart', e => {
      e.stopPropagation();
      dnd = { type: 'widget', id: iframe.id };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', iframe.id);
      setTimeout(() => { card.style.opacity = '0.4'; }, 0);
    });
    handle.addEventListener('dragend', () => {
      card.style.opacity = '';
      clearWidgetIndicators();
      dnd = { type: null };
    });
    hdr.insertBefore(handle, hTitle);
  }
  card.appendChild(hdr);

  // iFrame body
  const frame = document.createElement('iframe');
  frame.src = iframe.url;
  frame.className = 'w-full border-0';
  frame.style.height = `${iframe.height || 300}px`;
  frame.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms');
  frame.loading = 'lazy';
  card.appendChild(frame);
  return card;
}

// â”€â”€â”€ RSS fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function fetchRss(feed) {
  const el = document.getElementById(`rss-${feed.id}`);
  if (!el) return;
  const h = el.offsetHeight;
  if (h) el.style.minHeight = h + 'px';
  el.innerHTML = '';
  el.appendChild(mkCardSpinner());
  try {
    const res = await fetch(`/api/rss?url=${encodeURIComponent(feed.url)}`);
    if (!res.ok) throw new Error(res.status);
    renderRssItems(feed, await res.json());
  } catch (err) {
    el.innerHTML = `<p class="px-0 py-1 text-xs text-red-400">${err.message}</p>`;
  } finally {
    el.style.minHeight = '';
  }
}

function renderRssItems(feed, data) {
  const el = document.getElementById(`rss-${feed.id}`);
  if (!el) return;
  const items = (data.items || []).slice(0, feed.maxItems || 5);
  if (!items.length) { el.innerHTML = `<p class="text-xs ${FIXED.sub}">No items found.</p>`; return; }

  const ul = document.createElement('ul');
  ul.className = 'divide-y divide-black/[0.06] dark:divide-white/[0.08]';
  items.forEach(item => {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = item.link;
    a.target = '_blank';
    a.rel = 'noopener';
    a.className = `flex flex-col px-4 py-2 hover:bg-black/5 dark:hover:bg-white/5 transition-colors`;
    const titleEl = document.createElement('span');
    titleEl.className = `text-sm ${FIXED.text} line-clamp-2`;
    titleEl.textContent = item.title;
    a.appendChild(titleEl);
    if (item.date) {
      const dateEl = document.createElement('span');
      dateEl.className = `text-xs ${FIXED.sub} mt-0.5`;
      try {
        const d = new Date(item.date);
        const diff = Date.now() - d.getTime();
        const mins = Math.floor(diff / 60000);
        const hrs  = Math.floor(mins / 60);
        const days = Math.floor(hrs / 24);
        dateEl.textContent = days > 0 ? `${days}d ago` : hrs > 0 ? `${hrs}h ago` : mins > 0 ? `${mins}m ago` : 'just now';
      } catch { dateEl.textContent = item.date; }
      a.appendChild(dateEl);
    }
    li.appendChild(a);
    ul.appendChild(li);
  });
  el.innerHTML = '';
  el.className = '';
  el.appendChild(ul);
}

// â”€â”€â”€ Note modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openNoteModal(note) {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = note ? 'Edit note' : 'Add note';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('Title', b.sub));
  const titleInput = mkInput(note ? note.title : '', 'e.g. Ideas, TODO', b);
  wrap.appendChild(titleInput);

  const contentLabel = mkLabel('Content', b.sub);
  contentLabel.className += ' mt-3 block';
  wrap.appendChild(contentLabel);

  const contentHint = document.createElement('p');
  contentHint.className = `text-xs mb-1 ${b.sub}`;
  contentHint.textContent = 'Supports **bold**, *italic*, `code`, and - lists.';
  wrap.appendChild(contentHint);

  const contentArea = document.createElement('textarea');
  contentArea.value = note ? (note.content || '') : '';
  contentArea.placeholder = 'Write your note hereâ€¦';
  contentArea.autocomplete = 'off';
  contentArea.rows = 6;
  contentArea.className = `w-full px-3 py-2 rounded-lg text-sm border ${b.card} ${b.text} focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all resize-y font-mono`;
  wrap.appendChild(contentArea);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);

  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.textContent = note ? 'Save' : 'Create';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    const t = titleInput.value.trim() || 'Notes';
    const c = contentArea.value.trim();
    if (note) {
      await api('PUT', `/api/notes/${note.id}`, { title: t, content: c });
    } else {
      await api('POST', '/api/notes', { title: t, content: c });
    }
    closeModal();
    await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);

  openModal(wrap);
  titleInput.focus();
}

// â”€â”€â”€ Feed modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openFeedModal(feed) {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = feed ? 'Edit feed' : 'Add RSS feed';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('Title', b.sub));
  const titleInput = mkInput(feed ? feed.title : '', 'e.g. Tech News', b);
  wrap.appendChild(titleInput);

  const urlLabel = mkLabel('Feed URL', b.sub);
  urlLabel.className += ' mt-3 block';
  wrap.appendChild(urlLabel);
  const urlInput = mkInput(feed ? feed.url : '', 'https://example.com/feed.xml', b);
  urlInput.type = 'url';
  wrap.appendChild(urlInput);

  const maxLabel = mkLabel('Max items', b.sub);
  maxLabel.className += ' mt-3 block';
  wrap.appendChild(maxLabel);

  let selectedMax = feed ? (feed.maxItems || 5) : 5;
  const maxRow = document.createElement('div');
  maxRow.className = 'flex gap-2 mt-1';
  const piBase   = 'px-4 py-1.5 rounded-lg text-sm border transition-colors';
  const piActive = 'bg-indigo-600 text-white border-indigo-600';
  const piIdle   = `border-stone-300 dark:border-stone-600 ${b.text} hover:bg-stone-100 dark:hover:bg-stone-700`;
  [3, 5, 10].forEach(n => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = String(n);
    btn.dataset.val = n;
    btn.className = `${piBase} ${n === selectedMax ? piActive : piIdle}`;
    btn.addEventListener('click', () => {
      selectedMax = n;
      maxRow.querySelectorAll('button').forEach(b2 => {
        b2.className = `${piBase} ${Number(b2.dataset.val) === selectedMax ? piActive : piIdle}`;
      });
    });
    maxRow.appendChild(btn);
  });
  wrap.appendChild(maxRow);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);

  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.textContent = feed ? 'Save' : 'Create';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    const t = titleInput.value.trim() || 'Feed';
    const u = urlInput.value.trim();
    if (!u) { urlInput.focus(); return; }
    if (feed) {
      await api('PUT', `/api/feeds/${feed.id}`, { title: t, url: u, maxItems: selectedMax });
    } else {
      await api('POST', '/api/feeds', { title: t, url: u, maxItems: selectedMax });
    }
    closeModal();
    await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);

  openModal(wrap);
  titleInput.focus();
}

// â”€â”€â”€ iFrame modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openIframeModal(iframe) {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = iframe ? 'Edit embed' : 'Add embed';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('Title', b.sub));
  const titleInput = mkInput(iframe ? iframe.title : '', 'e.g. Grafana', b);
  wrap.appendChild(titleInput);

  const urlLabel = mkLabel('URL', b.sub);
  urlLabel.className += ' mt-3 block';
  wrap.appendChild(urlLabel);
  const urlInput = mkInput(iframe ? iframe.url : '', 'https://grafana.example.com/d/...', b);
  urlInput.type = 'url';
  wrap.appendChild(urlInput);

  const heightLabel = mkLabel('Height (px)', b.sub);
  heightLabel.className += ' mt-3 block';
  wrap.appendChild(heightLabel);

  let selectedHeight = iframe ? (iframe.height || 300) : 300;
  const heightRow = document.createElement('div');
  heightRow.className = 'flex gap-2 mt-1 flex-wrap';
  const piBase   = 'px-4 py-1.5 rounded-lg text-sm border transition-colors';
  const piActive = 'bg-indigo-600 text-white border-indigo-600';
  const piIdle   = `border-stone-300 dark:border-stone-600 ${b.text} hover:bg-stone-100 dark:hover:bg-stone-700`;
  [200, 300, 500, 800].forEach(n => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = String(n);
    btn.dataset.val = n;
    btn.className = `${piBase} ${n === selectedHeight ? piActive : piIdle}`;
    btn.addEventListener('click', () => {
      selectedHeight = n;
      heightRow.querySelectorAll('button').forEach(b2 => {
        b2.className = `${piBase} ${Number(b2.dataset.val) === selectedHeight ? piActive : piIdle}`;
      });
    });
    heightRow.appendChild(btn);
  });
  wrap.appendChild(heightRow);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);

  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.textContent = iframe ? 'Save' : 'Create';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    const t = titleInput.value.trim() || 'Embed';
    const u = urlInput.value.trim();
    if (!u) { urlInput.focus(); return; }
    if (iframe) {
      await api('PUT', `/api/iframes/${iframe.id}`, { title: t, url: u, height: selectedHeight });
    } else {
      await api('POST', '/api/iframes', { title: t, url: u, height: selectedHeight });
    }
    closeModal();
    await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);

  openModal(wrap);
  titleInput.focus();
}

// â”€â”€â”€ Countdown card + modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderCountdownCard(cd) {
  const cfg = state.config;
  const t   = TOPBAR[cfg.basePalette] || TOPBAR.stone;
  const b   = FIXED;
  const card = document.createElement('div');
  card.className = `group-section rounded-xl overflow-hidden border shadow-md ${b.card}`;

  const hdr = document.createElement('div');
  hdr.className = `flex items-center justify-between px-4 py-2.5 ${t.bar} ${t.text}`;
  const hTitle = document.createElement('span');
  hTitle.className = 'font-semibold text-sm tracking-wide truncate flex-1';
  hTitle.textContent = cd.title || 'Countdown';
  hdr.appendChild(hTitle);
  if (state.editMode) {
    hdr.appendChild(mkBtn('âœ', 'Edit', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => openCountdownModal(cd)));
    hdr.appendChild(mkBtn('âœ•', 'Delete', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', async () => {
      if (!confirm(`Delete countdown "${cd.title}"?`)) return;
      await api('DELETE', `/api/countdowns/${cd.id}`);
      await reload();
    }));
    const handle = mkHandle('text-white/60 hover:text-white/90 text-base');
    handle.draggable = true;
    handle.addEventListener('dragstart', e => { e.stopPropagation(); dnd = { type: 'widget', id: cd.id }; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', cd.id); setTimeout(() => { card.style.opacity = '0.4'; }, 0); });
    handle.addEventListener('dragend', () => { card.style.opacity = ''; clearWidgetIndicators(); dnd = { type: null }; });
    hdr.insertBefore(handle, hTitle);
  }
  card.appendChild(hdr);

  const body = document.createElement('div');
  body.className = `px-4 py-4 text-center ${b.text}`;

  function updateDisplay() {
    const target = new Date(cd.targetDate);
    const now    = Date.now();
    const diff   = target - now;
    const past   = diff < 0;
    const abs    = Math.abs(diff);
    const days   = Math.floor(abs / 86400000);
    const hours  = Math.floor((abs % 86400000) / 3600000);
    const mins   = Math.floor((abs % 3600000)  / 60000);
    const secs   = Math.floor((abs % 60000)    / 1000);
    body.innerHTML = `
      <div class="text-3xl font-bold tabular-nums mb-1">${days}<span class="text-base font-normal opacity-60">d</span> ${String(hours).padStart(2,'0')}<span class="text-base font-normal opacity-60">h</span> ${String(mins).padStart(2,'0')}<span class="text-base font-normal opacity-60">m</span> ${String(secs).padStart(2,'0')}<span class="text-base font-normal opacity-60">s</span></div>
      <div class="text-xs opacity-60">${past ? 'passed' : 'remaining'} Â· ${new Date(cd.targetDate).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' })}</div>
      ${cd.description ? `<div class="text-xs mt-1 opacity-50">${cd.description}</div>` : ''}
    `;
  }
  updateDisplay();
  const timer = setInterval(updateDisplay, 1000);
  card.addEventListener('disconnectedCallback', () => clearInterval(timer));
  // Clean up when card is removed from DOM
  new MutationObserver(() => { if (!document.contains(card)) clearInterval(timer); }).observe(document.body, { childList: true, subtree: true });

  card.appendChild(body);
  return card;
}

function openCountdownModal(cd) {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = cd ? 'Edit countdown' : 'Add countdown';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('Title', b.sub));
  const titleInput = mkInput(cd?.title || '', 'e.g. SSL cert renewal', b);
  wrap.appendChild(titleInput);

  const dateLabel = mkLabel('Target date', b.sub);
  dateLabel.className += ' mt-3 block';
  wrap.appendChild(dateLabel);
  const dateInput = document.createElement('input');
  dateInput.type = 'date';
  dateInput.value = cd?.targetDate ? cd.targetDate.slice(0, 10) : '';
  dateInput.autocomplete = 'off';
  dateInput.className = `w-full px-3 py-2 rounded-lg text-sm border ${b.card} ${b.text} focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all`;
  wrap.appendChild(dateInput);

  const descLabel = mkLabel('Description (optional)', b.sub);
  descLabel.className += ' mt-3 block';
  wrap.appendChild(descLabel);
  const descInput = mkInput(cd?.description || '', 'Short noteâ€¦', b);
  wrap.appendChild(descInput);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button'; cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);
  const saveBtn = document.createElement('button');
  saveBtn.type = 'button'; saveBtn.textContent = cd ? 'Save' : 'Create';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    const t = titleInput.value.trim() || 'Countdown';
    const d = dateInput.value;
    if (!d) { dateInput.focus(); return; }
    if (cd) { await api('PUT', `/api/countdowns/${cd.id}`, { title: t, targetDate: d, description: descInput.value.trim() }); }
    else    { await api('POST', '/api/countdowns', { title: t, targetDate: d, description: descInput.value.trim() }); }
    closeModal(); await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);
  openModal(wrap);
  titleInput.focus();
}

// â”€â”€â”€ Calendar card + modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const icalDataCache = new Map(); // calId â†’ { events, time }

async function fetchIcal(cal) {
  const body = document.getElementById(`ical-${cal.id}`);
  if (!body) return;
  const cached = icalDataCache.get(cal.id);
  if (cached) { renderIcalEvents(body, cached.events, cal.maxItems); return; }
  const h = body.offsetHeight;
  if (h) body.style.minHeight = h + 'px';
  body.innerHTML = '';
  body.appendChild(mkCardSpinner());
  try {
    const data = await api('GET', `/api/ical?url=${encodeURIComponent(cal.url)}`);
    icalDataCache.set(cal.id, data);
    renderIcalEvents(body, data.events, cal.maxItems);
  } catch { body.textContent = 'Failed to load.'; }
  finally { body.style.minHeight = ''; }
}

function renderIcalEvents(body, events, maxItems) {
  const b = FIXED;
  const upcoming = events.filter(e => new Date(e.date) >= new Date(Date.now() - 86400000)).slice(0, maxItems || 10);
  if (!upcoming.length) { body.textContent = 'No upcoming events.'; return; }
  body.innerHTML = '';
  upcoming.forEach(ev => {
    const row = document.createElement('div');
    row.className = `px-4 py-2.5 border-b border-black/[0.06] dark:border-white/[0.08] last:border-0`;
    const date = new Date(ev.date);
    const dateStr = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', weekday: 'short' });
    row.innerHTML = `<div class="text-sm font-medium truncate ${b.text}">${ev.summary}</div><div class="text-xs ${b.sub}">${dateStr}${ev.location ? ' Â· ' + ev.location : ''}</div>`;
    body.appendChild(row);
  });
}

function renderCalendarCard(cal) {
  const cfg = state.config;
  const t   = TOPBAR[cfg.basePalette] || TOPBAR.stone;
  const b   = FIXED;
  const card = document.createElement('div');
  card.className = `group-section rounded-xl overflow-hidden border shadow-md ${b.card}`;

  const hdr = document.createElement('div');
  hdr.className = `flex items-center justify-between px-4 py-2.5 ${t.bar} ${t.text}`;
  const hTitle = document.createElement('span');
  hTitle.className = 'font-semibold text-sm tracking-wide truncate flex-1';
  hTitle.textContent = cal.title || 'Calendar';
  hdr.appendChild(hTitle);
  hdr.appendChild(mkBtn('â†»', 'Refresh', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => { icalDataCache.delete(cal.id); fetchIcal(cal); }));
  if (state.editMode) {
    hdr.appendChild(mkBtn('âœ', 'Edit', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', () => openCalendarModal(cal)));
    hdr.appendChild(mkBtn('âœ•', 'Delete', 'opacity-70 hover:opacity-100 text-base px-1 transition-opacity', async () => {
      if (!confirm(`Delete calendar "${cal.title}"?`)) return;
      await api('DELETE', `/api/calendars/${cal.id}`);
      await reload();
    }));
    const handle = mkHandle('text-white/60 hover:text-white/90 text-base');
    handle.draggable = true;
    handle.addEventListener('dragstart', e => { e.stopPropagation(); dnd = { type: 'widget', id: cal.id }; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', cal.id); setTimeout(() => { card.style.opacity = '0.4'; }, 0); });
    handle.addEventListener('dragend', () => { card.style.opacity = ''; clearWidgetIndicators(); dnd = { type: null }; });
    hdr.insertBefore(handle, hTitle);
  }
  card.appendChild(hdr);

  const body = document.createElement('div');
  body.id = `ical-${cal.id}`;
  body.className = `text-xs ${b.sub} px-4 py-3`;
  body.appendChild(mkCardSpinner());
  card.appendChild(body);
  return card;
}

function openCalendarModal(cal) {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = cal ? 'Edit calendar' : 'Add calendar';
  wrap.appendChild(title);

  wrap.appendChild(mkLabel('Title', b.sub));
  const titleInput = mkInput(cal?.title || '', 'e.g. Family Calendar', b);
  wrap.appendChild(titleInput);

  const urlLabel = mkLabel('iCal URL (.ics)', b.sub);
  urlLabel.className += ' mt-3 block';
  wrap.appendChild(urlLabel);
  const urlInput = mkInput(cal?.url || '', 'https://example.com/calendar.ics', b);
  wrap.appendChild(urlInput);

  let selectedMax = cal?.maxItems || 10;
  const maxLabel = mkLabel('Max events', b.sub);
  maxLabel.className += ' mt-3 block';
  wrap.appendChild(maxLabel);
  const maxRow = document.createElement('div');
  maxRow.className = 'flex gap-2 flex-wrap';
  [5, 10, 15, 20].forEach(n => {
    const btn = document.createElement('button');
    btn.type = 'button'; btn.textContent = n;
    btn.className = `px-3 py-1.5 rounded-lg text-sm border transition-colors ${selectedMax === n ? 'bg-indigo-600 text-white border-indigo-600' : `border-stone-300 dark:border-stone-600 ${b.text}`}`;
    btn.onclick = () => { selectedMax = n; maxRow.querySelectorAll('button').forEach(b => b.className = b.className.replace(/bg-indigo-600 text-white border-indigo-600/, `border-stone-300 dark:border-stone-600 ${FIXED.text}`)); btn.className = btn.className.replace(/border-stone-300 dark:border-stone-600 [^ ]+/, 'bg-indigo-600 text-white border-indigo-600'); };
    maxRow.appendChild(btn);
  });
  wrap.appendChild(maxRow);

  const footer = document.createElement('div');
  footer.className = 'flex justify-end gap-2 mt-6';
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button'; cancelBtn.textContent = 'Cancel';
  cancelBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  cancelBtn.onclick = closeModal;
  footer.appendChild(cancelBtn);
  const saveBtn = document.createElement('button');
  saveBtn.type = 'button'; saveBtn.textContent = cal ? 'Save' : 'Create';
  saveBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors';
  saveBtn.onclick = async () => {
    const t = titleInput.value.trim() || 'Calendar';
    const u = urlInput.value.trim();
    if (!u) { urlInput.focus(); return; }
    if (cal) { await api('PUT', `/api/calendars/${cal.id}`, { title: t, url: u, maxItems: selectedMax }); }
    else     { await api('POST', '/api/calendars', { title: t, url: u, maxItems: selectedMax }); }
    closeModal(); await reload();
  };
  footer.appendChild(saveBtn);
  wrap.appendChild(footer);
  openModal(wrap);
  titleInput.focus();
}

// â”€â”€â”€ Keybinds modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openKeybindsModal() {
  const b = FIXED;
  const wrap = document.createElement('div');

  const title = document.createElement('h2');
  title.className = `text-lg font-semibold mb-4 ${b.text}`;
  title.textContent = 'Keyboard shortcuts';
  wrap.appendChild(title);

  // Navigation section
  const navTitle = document.createElement('p');
  navTitle.className = `text-xs font-semibold uppercase tracking-wider mb-2 ${b.sub}`;
  navTitle.textContent = 'Navigation';
  wrap.appendChild(navTitle);

  const navShortcuts = [
    { keys: ['âŒƒK', 'âŒ˜K'], desc: 'Open search' },
    { keys: ['/'],         desc: 'Open search' },
    { keys: ['Esc'],       desc: 'Close modal / search / menu' },
    { keys: ['âŒƒ=', 'âŒ˜='], desc: 'Zoom in' },
    { keys: ['âŒƒâˆ’', 'âŒ˜âˆ’'], desc: 'Zoom out' },
    { keys: ['âŒƒ0', 'âŒ˜0'], desc: 'Reset zoom' },
    { keys: ['â†µ'],         desc: 'Open focused link' },
  ];

  const navTable = document.createElement('div');
  navTable.className = 'space-y-2 mb-4';
  navShortcuts.forEach(({ keys, desc }) => {
    const row = document.createElement('div');
    row.className = 'flex items-center gap-3';
    const kbdWrap = document.createElement('div');
    kbdWrap.className = 'flex gap-1 flex-shrink-0 min-w-[5rem]';
    keys.forEach(k => {
      const kbd = document.createElement('kbd');
      kbd.className = `text-xs font-mono px-1.5 py-0.5 rounded border border-stone-200 dark:border-stone-700 ${b.sub} bg-stone-50 dark:bg-stone-900`;
      kbd.textContent = k;
      kbdWrap.appendChild(kbd);
    });
    const descEl = document.createElement('span');
    descEl.className = `text-sm ${b.text}`;
    descEl.textContent = desc;
    row.appendChild(kbdWrap);
    row.appendChild(descEl);
    navTable.appendChild(row);
  });
  wrap.appendChild(navTable);

  // Link hotkeys section
  const sep = document.createElement('hr');
  sep.className = 'my-3 border-stone-200 dark:border-stone-700';
  wrap.appendChild(sep);

  const linkTitle = document.createElement('p');
  linkTitle.className = `text-xs font-semibold uppercase tracking-wider mb-1 ${b.sub}`;
  linkTitle.textContent = 'Link hotkeys';
  wrap.appendChild(linkTitle);

  const linkHint = document.createElement('p');
  linkHint.className = `text-xs mb-3 ${b.sub}`;
  linkHint.textContent = 'Assigned in Edit mode â†’ link âœ';
  wrap.appendChild(linkHint);

  const allLinks = (state.config?.groups || []).flatMap(g => g.links).filter(l => l.hotkey);
  if (allLinks.length === 0) {
    const none = document.createElement('p');
    none.className = `text-sm ${b.sub} italic`;
    none.textContent = '(none assigned yet)';
    wrap.appendChild(none);
  } else {
    const grid = document.createElement('div');
    grid.className = 'flex flex-wrap gap-3';
    allLinks.forEach(link => {
      const chip = document.createElement('div');
      chip.className = `flex items-center gap-1.5 text-sm ${b.text}`;
      const kbd = document.createElement('kbd');
      kbd.className = `text-xs font-mono px-1.5 py-0.5 rounded border border-stone-200 dark:border-stone-700 ${b.sub} bg-stone-50 dark:bg-stone-900`;
      kbd.textContent = link.hotkey.toUpperCase();
      chip.appendChild(kbd);
      const nameEl = document.createElement('span');
      nameEl.textContent = link.name;
      chip.appendChild(nameEl);
      grid.appendChild(chip);
    });
    wrap.appendChild(grid);
  }

  const footer = document.createElement('div');
  footer.className = 'flex justify-end mt-6';
  const closeBtn = document.createElement('button');
  closeBtn.type = 'button';
  closeBtn.textContent = 'Close';
  closeBtn.className = `px-4 py-2 rounded-lg text-sm font-medium border ${b.text} opacity-60 hover:opacity-100 transition-opacity`;
  closeBtn.onclick = closeModal;
  footer.appendChild(closeBtn);
  wrap.appendChild(footer);

  openModal(wrap);
}

// â”€â”€â”€ Wire up controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('menuTheme').addEventListener('click', async () => {
  const dark = !state.config.darkMode;
  state.config.darkMode = dark;
  applyTheme(dark);
  closeMenu();
  await api('PUT', '/api/config', { darkMode: dark });
});

document.getElementById('menuBtn').addEventListener('click', e => {
  e.stopPropagation();
  menuOpen = !menuOpen;
  document.getElementById('menuDropdown').classList.toggle('hidden', !menuOpen);
});

document.getElementById('menuSearch').addEventListener('click', () => {
  closeMenu();
  openSearch();
});

document.getElementById('menuSettings').addEventListener('click', () => {
  closeMenu();
  openSettingsModal();
});

document.getElementById('menuEdit').addEventListener('click', () => {
  closeMenu();
  state.editMode = !state.editMode;
  render();
});

document.getElementById('menuShortcuts').addEventListener('click', () => {
  closeMenu();
  openKeybindsModal();
});

document.getElementById('menuViewToggle').addEventListener('click', async () => {
  closeMenu();
  const next = state.config.viewMode === 'list' ? 'grid' : 'list';
  await api('PUT', '/api/config', { viewMode: next });
  state.config.viewMode = next;
  render();
});

document.getElementById('menuClockToggle').addEventListener('click', async () => {
  closeMenu();
  const next = !state.config.showClock;
  await api('PUT', '/api/config', { showClock: next });
  state.config.showClock = next;
  render();
});

document.getElementById('menuZoomOut').addEventListener('click', () => {
  const idx = ZOOM_LEVELS.indexOf(currentZoom);
  if (idx > 0) applyZoom(ZOOM_LEVELS[idx - 1]);
});
document.getElementById('menuZoomReset').addEventListener('click', () => applyZoom(100));
document.getElementById('menuZoomIn').addEventListener('click', () => {
  const idx = ZOOM_LEVELS.indexOf(currentZoom);
  if (idx < ZOOM_LEVELS.length - 1) applyZoom(ZOOM_LEVELS[idx + 1]);
});

document.addEventListener('click', e => {
  if (menuOpen && !document.getElementById('menuBtn').contains(e.target)) closeMenu();
});

document.getElementById('searchOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeSearch();
});

document.getElementById('searchInput').addEventListener('input', e => {
  renderSearchResults(e.target.value);
});

document.getElementById('dashTitle').addEventListener('click', openSettingsModal);

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateClock() {
  const now = new Date();
  const timeEl = document.getElementById('clockCardTime');
  if (timeEl) timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const dateEl = document.getElementById('clockCardDate');
  if (dateEl) dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
}
setInterval(updateClock, 30_000);

reload();

// Show sign-out in menu if auth is enabled
api('GET', '/api/auth').then(({ enabled }) => {
  if (enabled) {
    document.getElementById('menuLogout').classList.remove('hidden');
    document.getElementById('menuLogoutSep').classList.remove('hidden');
  }
}).catch(() => {});
</script>

</body>
</html>
